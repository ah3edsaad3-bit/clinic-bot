from flask import Flask, request
import requests
from openai import OpenAI
import time
import os
import threading
import re
import json
from datetime import datetime, timedelta

app = Flask(__name__)

# =======================================================
# ğŸ”‘ TOKENS
# =======================================================
VERIFY_TOKEN = "goldenline_secret"
PAGE_ACCESS_TOKEN = os.getenv("PAGE_ACCESS_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=OPENAI_API_KEY)

WHATSAPP_URL = (
    "https://api.callmebot.com/whatsapp.php?"
    "phone=9647818931201&apikey=8423339&text="
)

BOOKING_API_URL = "https://script.google.com/macros/s/AKfycbznSh6PeJodzuAqObqo9_kWIfgLoZHhrJ97C4pEXCXwD9JD4s3wZ9I93MRl0ot6d36-1g/exec"

# =======================================================
# ğŸ“Š DAILY STATS
# =======================================================
DAILY_BOOKINGS = 0
DAILY_MESSAGES = 0
DAILY_INCOMPLETE = 0

# =======================================================
# ğŸ§  SESSIONS
# =======================================================
SESSIONS = {}
BUFFER_DELAY = 15
MEMORY_TIMEOUT = 900


# =======================================================
# ğŸ”¥ AUTO CLEANER
# =======================================================
def cleaner_daemon():
    while True:
        now = time.time()
        for uid in list(SESSIONS.keys()):
            if now - SESSIONS[uid]["last_message_time"] > 3600:
                del SESSIONS[uid]
        time.sleep(3600)

threading.Thread(target=cleaner_daemon, daemon=True).start()


# =======================================================
# âœï¸ Typing Indicator
# =======================================================
def send_typing(receiver):
    if not PAGE_ACCESS_TOKEN:
        return

    url = "https://graph.facebook.com/v18.0/me/messages"
    params = {"access_token": PAGE_ACCESS_TOKEN}
    payload = {"recipient": {"id": receiver}, "sender_action": "typing_on"}
    requests.post(url, params=params, json=payload)


# =======================================================
# ğŸ”¢ Utility Functions
# =======================================================
def normalize_numbers(text):
    arabic = "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"
    english = "0123456789"
    return text.translate(str.maketrans(arabic, english))


def extract_phone(text):
    text = normalize_numbers(text)
    m = re.findall(r"07\d{9}", text)
    return m[0] if m else None


def extract_name(text):
    t = normalize_numbers(text)
    cleaned = ''.join([c if not c.isdigit() else ' ' for c in t])
    return cleaned.strip() if len(cleaned.strip()) > 1 else None


# =======================================================
# ğŸ“… Next weekday name â†’ date
# =======================================================
def next_weekday_by_name(day_name):
    days = {
        "monday": 0, "tuesday": 1, "wednesday": 2,
        "thursday": 3, "friday": 4, "saturday": 5, "sunday": 6,
        "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†": 0, "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡": 1, "Ø§Ù„Ø§Ø±Ø¨Ø¹Ø§Ø¡": 2, "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡": 2,
        "Ø§Ù„Ø®Ù…ÙŠØ³": 3, "Ø§Ù„Ø¬Ù…Ø¹Ø©": 4, "Ø§Ù„Ø³Ø¨Øª": 5, "Ø§Ù„Ø§Ø­Ø¯": 6, "Ø§Ù„Ø£Ø­Ø¯": 6,
    }

    dn = day_name.strip().lower()
    if dn not in days:
        return None

    target = days[dn]
    today = datetime.now()
    diff = target - today.weekday()
    if diff <= 0:
        diff += 7

    result = today + timedelta(days=diff)
    return result.strftime("%Y-%m-%d")


# =======================================================
# ğŸ“… Default date = tomorrow unless Friday â†’ Saturday
# =======================================================
def get_default_date():
    today = datetime.now()
    d = today + timedelta(days=1)

    if d.weekday() == 4:  # Friday
        d += timedelta(days=1)

    return d.strftime("%Y-%m-%d")


# =======================================================
# ğŸ§  Chat Delay Reply
# =======================================================
def schedule_reply(user_id):
    time.sleep(BUFFER_DELAY)
    st = SESSIONS.get(user_id)
    if not st:
        return

    now = time.time()
    if now - st["last_message_time"] >= BUFFER_DELAY:
        send_typing(user_id)
        last_msg = st["history"][-1]
        reply = ask_openai_chat(user_id, last_msg)
        if reply:
            send_message(user_id, reply)


# =======================================================
# ğŸ“¥ Last Messages
# =======================================================
def get_last_messages(user_id, limit=10):
    return SESSIONS.get(user_id, {}).get("history", [])[-limit:]


# =======================================================
# ğŸ¤– Booking Engine
# =======================================================
def analyze_booking(name, phone, last_msgs):
    history = "\n".join(last_msgs)

    prompt = f"""
Ø§Ù‚Ø±Ø£ Ø¢Ø®Ø± Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙˆØ­Ø¯Ø¯ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®.
Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† JSON ÙÙ‚Ø·.

Ù…Ø«Ø§Ù„ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬:

{{
 "patient_name": "Ø§Ù„Ø§Ø³Ù…",
 "patient_phone": "{phone}",
 "service": "Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¬Ø§Ù†ÙŠØ©",
 "day_name": "Ø§Ù„Ø®Ù…ÙŠØ³ Ø£Ùˆ Thursday Ø£Ùˆ ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØ°ÙƒØ± ÙŠÙˆÙ…",
 "time": "HH:MM" (Ø¥Ø°Ø§ Ù„Ù… ÙŠØ°ÙƒØ± ÙˆÙ‚Øª ÙŠÙƒÙˆÙ† 16:00)
}}

â— Ù„Ø§ ØªØ­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®. ÙÙ‚Ø· Ø£Ø±Ø¬Ø¹ day_name.
"""

    try:
        rsp = client.chat.completions.create(
            model="gpt-4.1",
            messages=[
                {"role": "system", "content": prompt},
                {"role": "user", "content": history}
            ],
            max_tokens=250,
            temperature=0
        )

        data = json.loads(rsp.choices[0].message.content)

        patient_name = data.get("patient_name") or name or "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"
        day_name = data.get("day_name", "").strip()
        time_str = data.get("time") or "16:00"

        if day_name:
            date = next_weekday_by_name(day_name)
            if not date:
                date = get_default_date()
        else:
            date = get_default_date()

        # Message formatting
        ai_msg = (
            "ØªÙ… ØªØ«Ø¨ÙŠØª Ù…ÙˆØ¹Ø¯Ùƒ â¤\n"
            f"Ø§Ù„Ø§Ø³Ù…: {patient_name}\n"
            f"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {phone}\n"
            f"Ø§Ù„Ø®Ø¯Ù…Ø©: Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¬Ø§Ù†ÙŠØ©\n"
            f"Ø§Ù„ØªØ§Ø±ÙŠØ®: {date}\n"
            f"Ø§Ù„ÙˆÙ‚Øª: {time_str}\n"
            "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø¨ØºØ¯Ø§Ø¯ / Ø²ÙŠÙˆÙ†Ø© / Ø´Ø§Ø±Ø¹ Ø§Ù„Ø±Ø¨ÙŠØ¹ÙŠ Ø§Ù„Ø®Ø¯Ù…ÙŠ / Ø¯Ø§Ø®Ù„ ÙƒØ±Ø§Ø¬ Ù…Ø¬Ù…Ø¹ Ø§Ø³Ø·Ù†Ø¨ÙˆÙ„ / Ø¹ÙŠØ§Ø¯Ø© ÙƒÙˆÙ„Ø¯Ù† Ù„Ø§ÙŠÙ†"
        )

        return {
            "patient_name": patient_name,
            "patient_phone": phone,
            "service": "Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¬Ø§Ù†ÙŠØ©",
            "date": date,
            "time": time_str,
            "ai_message": ai_msg
        }

    except:
        fallback_date = get_default_date()
        return {
            "patient_name": name or "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
            "patient_phone": phone,
            "service": "Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¬Ø§Ù†ÙŠØ©",
            "date": fallback_date,
            "time": "16:00",
            "ai_message":
                f"ØªÙ… ØªØ«Ø¨ÙŠØª Ù…ÙˆØ¹Ø¯Ùƒ â¤\n"
                f"Ø§Ù„Ø§Ø³Ù…: {name or 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}\n"
                f"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {phone}\n"
                f"Ø§Ù„ØªØ§Ø±ÙŠØ®: {fallback_date}\n"
                f"Ø§Ù„ÙˆÙ‚Øª: 16:00\n"
                "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø¨ØºØ¯Ø§Ø¯ / Ø²ÙŠÙˆÙ†Ø© / Ø´Ø§Ø±Ø¹ Ø§Ù„Ø±Ø¨ÙŠØ¹ÙŠ Ø§Ù„Ø®Ø¯Ù…ÙŠ / Ø¯Ø§Ø®Ù„ ÙƒØ±Ø§Ø¬ Ù…Ø¬Ù…Ø¹ Ø§Ø³Ø·Ù†Ø¨ÙˆÙ„ / Ø¹ÙŠØ§Ø¯Ø© ÙƒÙˆÙ„Ø¯Ù† Ù„Ø§ÙŠÙ†"
        }


# =======================================================
# ğŸ§¾ Save Booking into Sheet
# =======================================================
def save_booking_to_sheet(b):
    payload = {
        "action": "addBooking",
        "name": b["patient_name"],
        "phone": b["patient_phone"],
        "service": b["service"],
        "date": b["date"],
        "time": b["time"],
        "status": "Pending"
    }
    requests.post(BOOKING_API_URL, data=payload)


# =======================================================
# ğŸ“¤ WhatsApp Booking Notification
# =======================================================
def send_whatsapp_booking(name, phone, date, time_):
    msg = (
        "Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯:\n"
        f"Ø§Ù„Ø§Ø³Ù…: {name}\n"
        f"Ø§Ù„Ø±Ù‚Ù…: {phone}\n"
        f"Ø§Ù„ØªØ§Ø±ÙŠØ®: {date}\n"
        f"Ø§Ù„ÙˆÙ‚Øª: {time_}"
    )
    url = WHATSAPP_URL + requests.utils.quote(msg)
    requests.get(url)


# =======================================================
# ğŸ¤– Chat Engine (Ali)
# =======================================================
def ask_openai_chat(user_id, text):
    st = SESSIONS[user_id]
    history_text = " | ".join(st["history"][:-1]) if len(st["history"]) > 1 else ""

    prompt = """ 
Ø§Ù†Øª Ø§Ø³Ù…Ùƒ Ø¹Ù„ÙŠ Ù…ÙˆØ¸Ù Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± Ø¨Ø¹ÙŠØ§Ø¯Ø© ÙƒÙˆÙ„Ø¯Ù† Ù„Ø§ÙŠÙ† Ù„Ø·Ø¨ Ø§Ù„Ø§Ø³Ù†Ø§Ù†ØŒ
ÙˆØ¶ÙŠÙØªÙƒ ØªØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©  ØŒ ÙˆØ¨Ø¯ÙˆÙ† Ù…Ø¨Ø§Ù„ØºØ© ÙˆØªØ¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙ‡Ù… Ø¨Ø·Ø±ÙŠÙ‚Ø© ØªØ·Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹

Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙ‚Ø· Ù…Ù† 2 Ø§Ù„Ù‰ 10 ÙƒÙ„Ù…Ø§Øª ) 
 
Ù…Ù„Ø§Ø­Ø¸Ø© Ù¡ :- ØªØ£Ø®Ø° Ø¨Ø¹ÙŠÙ† Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØªØ±Ø¯ Ø¹Ù„Ù‰ Ø£Ø®ÙŠØ± Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·
 .
Ù…Ù„Ø§Ø­Ø¸Ø© Ù¢ :- Ø§Ø°Ø§ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ù†Ø¯Ø© Ø´ÙƒÙˆØ© Ø§Ùˆ Ø¹ØµØ¨ÙŠ Ø§Ùˆ ÙŠØ´ØªÙƒÙŠ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ØŒ ØªØ¹ØªØ°Ø± Ù…Ù†Ù‡ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù‡Ø°Ø¨Ø© ÙˆØªØ·Ù„Ø¨ Ù…Ù†Ù‡ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ† Ø­ØªÙ‰ Ù†ØªØµÙ„ Ø¨ÙŠÙ‡ ÙˆØ§Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„ØªØ°Ù…Ø± ( Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù„ØºØ© ÙŠØªØµÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙˆØªÙ†ÙŠØ·Ù‡ Ø§Ù„Ø±Ù‚Ù… )

ÙˆÙ‡Ø§ÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠ Ø±Ø§Ø­ ØªØ³ØªÙØ§Ø¯ Ù…Ù†Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ† :-

ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© :-
Ø§Ù„Ø§Ø³Ù… : Ø¹ÙŠØ§Ø¯Ø© ÙƒÙˆÙ„Ø¯Ù† Ù„Ø§ÙŠÙ† Ù„Ø·Ø¨ ÙˆØªØ¬Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù†Ø§Ù†.
ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ù… : ÙŠÙˆÙ…ÙŠØ§ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© Ù¤Ù… Ø§Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© Ù©Ù… Ø¹Ø¯Ù‰ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø© Ø¹Ø·Ù„Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
Ø§Ù„Ø¹Ù†ÙˆØ§Ù† : Ø¨ØºØ¯Ø§Ø¯ Ø²ÙŠÙˆÙ†Ø© Ø´Ø§Ø±Ø¹ Ø§Ù„Ø±Ø¨ÙŠØ¹ÙŠ Ø§Ù„Ø®Ø¯Ù…ÙŠ Ø¯Ø§Ø®Ù„ ÙƒØ±Ø§Ø¬ Ù…Ø¬Ù…Ø¹ Ø§Ø³Ø·Ù†Ø¨ÙˆÙ„ 
Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ :- 07728802820


Ø§Ù„Ø­Ø´ÙˆØ© Ø§Ù„ØªØ¬Ù…ÙŠÙ„ÙŠØ© Ø¬Ù„Ø³Ø© ÙˆØ­Ø¯Ø©
Ø­Ø´ÙˆØ© Ø§Ù„Ø¬Ø°Ø± Ù…Ù† Ø¬Ù„Ø³Ø© Ø§Ù„Ù‰ Ø«Ù„Ø§Ø«Ø© Ø¬Ù„Ø³Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø³Ù†
ØªØºÙ„ÙŠÙ Ø§Ù„Ø§Ø³Ù†Ø§Ù† ( Ø²Ø§Ø±ÙƒÙˆÙ† ØŒ Ø§ÙŠÙ…Ø§ÙƒØ³ ) Ø®Ù„Ø§Ù„ Ø¬Ù„Ø³ØªÙŠÙ† ÙˆØ¨ÙŠÙ†Ø§ØªÙ‡Ù… Ù…Ù† Ù¥ Ø§Ù„Ù‰ Ù§ Ø£ÙŠØ§Ù…
Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©
Ø§Ø°Ø§ ÙƒØ§Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ù…Ø§ÙƒÙˆ ØªØ®ÙÙŠØ¶Ø§Øª  ÙˆÙŠØ·Ù„Ø¨ ØªØ®ÙÙŠØ¶ Ù„Ù„Ø³Ø¹Ø± ØªÙƒÙˆÙ„ Ø§Ù„Ù‡ Ù‡Ø§ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø¹Ø±ÙˆØ¶ ØŒ Ø¨Ø³ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù…ÙŠÙ‚ØµØ± ÙˆÙŠØ§Ùƒ Ø§Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡
Ø­Ø§ÙˆÙ„ ØªÙÙ‡Ù… Ø§Ù„Ø§ØºÙ„Ø§Ø· Ø§Ù„Ø§Ù…Ù„Ø§Ø¦ÙŠØ© ÙˆØªØµØ­ÙŠØ­Ù‡Ø§ Ø­Ø³Ø¨ ØµÙŠØ§Øº Ø§Ù„Ø¬Ù…Ù„Ø©
ØªÙ‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹ Ù…Ø«Ù„ ØªÙ‚ÙˆÙ… Ø¨Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³Ù†Ø§Ù† Ø§Ù„ÙŠ ÙŠØ±ÙŠØ¯Ù‡Ø§ Ø¨Ø¯ÙˆÙ† Ø°ÙƒØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© .... Ø§Ù„Ø® 
Ø§Ø°Ø§ Ø³Ø§Ù„Ùƒ Ø§Ù† Ù„Ø§Ø²Ù… Ø­Ø¬Ø² Ø§Ùˆ Ø±Ø§Ø¯ ÙŠØ­Ø¬Ø² ØªØ£Ø®Ø° Ù…Ù†Ù‡ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… ÙˆØ¨Ø¹Ø¯Ù‡Ø§ ØªØ¨Ù„ØºÙ‡ Ø§Ù† Ø±Ø§Ø­ ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆÙŠØ§Ù‡ Ù…Ù† Ù‚Ø¨Ù„ Ù‚Ø³Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø­Ø¬Ø²
Ù„Ø§ ØªÙ‚Ù… Ø¨Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø±ÙŠØ¨ Ø¨Ùƒ Ø§Ù„Ø£ÙˆÙ„
Ø§ÙŠ Ù†ÙˆØ¹ ØªØºÙ„ÙŠÙ ( Ø²Ø§Ø±ÙƒÙˆÙ† ØŒ Ø²Ø§Ø±ÙƒÙˆÙ† Ø§ÙŠÙ…Ø§ÙƒØ³ ) ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù‰ Ø¨Ø±Ø¯ Ø®ÙÙŠÙ Ø­ØªÙ‰ Ù…ØªØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø¨Ø§Ù„Ù„Ø«Ø© Ø¨Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
Ø§ÙƒÙˆ Ø§ØºÙ„Ø§Ø· Ø§Ù…Ù„Ø§Ø¦ÙŠØ© ÙˆÙ…Ø±Ø§Ø¯ÙØ§Øª Ø±Ø§Ø­ ØªØµØ¹Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„ÙÙ‡Ù… Ù…Ø«Ù„ ( Ù‚Ø¨Ù‚ ØŒ ØºÙ„Ø§Ù ØŒ ØªÙ‚Ø¨ÙŠÙ‚ = ØªØºÙ„ÙŠÙ ) ØŒ ( Ø·Ø§Ø­ ØŒ ÙˆÙƒØ¹ ØŒ Ø§Ù†Ø´Ù„Ø¹ = Ø§Ù†Ù‚Ù„Ø¹ ) ØŒ ( ØªØ­Ø´Ø§Ù‡ ØŒ ØªØ­Ø´ÙŠØ© = Ø­Ø´ÙˆØ© ) ØŒ ( Ù…Ø§ Ø¨ÙŠÙ‡Ø§ Ù…Ø¬Ø§Ù„ , Ù‡Ù„Ø§ Ù‡Ù„Ø§ Ø¨Ø§Ù„ÙÙ‚ÙŠØ± , Ø¹Ù„Ù‰ ÙƒÙŠÙÙƒÙ… ÙˆÙŠØ§Ù†Ù‡ , Ù…Ù†ÙŠÙ† Ø§Ø¬ÙŠØ¨\Ù†Ø¬ÙŠØ¨\ØªØ¬ÙŠØ¨ , Ù†Ø²Ù„ Ø§Ù„Ù†Ù‡ Ù…Ù† Ø§Ù„Ø³Ø¹Ø± = Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙŠØ·Ù„Ø¨ ØªØ®ÙÙŠØ¶ )ØŒ ( ÙŠÙˆØ¬Ø¹Ù†ÙŠ ØŒ ØªÙˆØ¬Ø¹ ØŒ ÙŠÙ…ÙˆØªÙ†ÙŠ = Ø§Ù„Ù… )
Ø§Ø°Ø§ ÙƒØ§Ù„ Ù…Ù†Ùˆ Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø§Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ± ÙƒÙ„Ù‡ Ø§Ø­Ù†Ø© Ù…Ø±ÙƒØ² ÙˆÙ…ÙˆØ¬ÙˆØ¯ Ø§ÙƒØ«Ø± Ù…Ù† Ø¯ÙƒØªÙˆØ± ÙˆÙƒÙ„Ù‡Ù… Ø§ÙƒÙØ§Ø¡ Ø¨Ø§Ù„Ø¹Ù…Ù„ , Ø§Ø°Ø§ ÙƒØ§Ù„ Ø¯ÙƒØªÙˆØ± Ù„Ùˆ Ø¯ÙƒØªÙˆØ±Ø© ÙƒÙˆÙ„ Ø§ÙƒÙˆ Ø¯ÙƒØªÙˆØ± ÙˆØ§ÙƒÙˆ Ø¯ÙƒØªÙˆØ±Ø©

Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠØ© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹):

Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¥Ù‚Ù†Ø§Ø¹:  ÙˆØ§Ø±Ø¨Ø· Ø§Ù„Ø³Ø¹Ø± Ø¨Ù€ (Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© + Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ). Ø­Ø³Ø³Ù‡ Ø¥Ù†Ù‡ Ù…Ø§Ø®Ø° ØµÙÙ‚Ø© Ù…Ù…ØªØ§Ø²Ø©.

Ø§Ù„Ø§Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶ :-
( Ø¹Ø±Ø¶ ØªØºÙ„ÙŠÙ Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ† ÙƒÙ„ ØªØºÙ„ÙŠÙÙŠÙ† Ø§Ù„Ø«Ø§Ù„Ø« Ù…Ø¬Ø§Ù†ÙŠ )
Ù¡: Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ† 100 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¢: Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ† Ø§ÙŠÙ…Ø§ÙƒØ³ 150 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù£: Ø§Ù„Ù‚Ù„Ø¹ 25 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¤: Ø§Ù„Ø­Ø´ÙˆØ© Ø§Ù„ØªØ¬Ù…ÙŠÙ„Ø© 35 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¥: Ø­Ø´ÙˆØ© Ø§Ù„Ø¬Ø°Ø± 125 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¦: ØªØ¨ÙŠÙŠØ¶ Ø§Ù„Ø§Ø³Ù†Ø§Ù† Ø¨Ø§Ù„Ù„ÙŠØ²Ø± 100 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù§: ØªÙ†Ø¶ÙŠÙ Ø§Ù„Ø§Ø³Ù†Ø§Ù† 25 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¨: ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø§Ø³Ù†Ø§Ù† 450 Ø§Ù„Ù Ù„Ù„ÙÙƒ
Ù©: Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ø§Ø³Ù†Ø§Ù† Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠÙ‡ ( Ø§Ù„ÙƒÙˆØ±ÙŠ 350 ØŒ Ø§Ù„Ø§Ù„Ù…Ø§Ù†ÙŠ 450 )
Ù¡Ù : Ø²Ø±Ø§Ø¹Ø© Ø§Ù„ÙÙƒ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²Ø±Ø¹Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ù…Ù„ÙŠÙˆÙ† Ùˆ 750 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø± Ø²Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø§Ù†ÙŠØ©
Ù¡Ù¡: Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡ÙŠØ± Ø²Ø§Ø±ÙƒÙˆÙ† 20 Ø³Ù† Ù…Ù„ÙŠÙˆÙ† Ùˆ 400 Ø§Ù„Ù 
Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡ÙŠØ± Ø²Ø§Ø±ÙƒÙˆÙ† Ø§ÙŠÙ…Ø§ÙƒØ³ 16 Ø³Ù† Ù…Ù„ÙŠÙˆÙ†ÙŠÙ†
12: Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ù…ØªÙˆÙØ± Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…ØªÙ‚Ø§Ø¹Ø¯ÙŠÙ† Ø¹Ù„Ù‰ Ù…ØµØ±Ù Ø§Ù„Ø±Ø§ÙØ¯ÙŠÙ† ( ÙƒÙŠ ÙƒØ§Ø±Ø¯ , Ù…Ø§Ø³ØªØ± ÙƒØ§Ø±Øª ) Ø£Ù‚Ø³Ø§Ø· Ù„Ù…Ø¯Ø© 10 Ø§Ø´Ù‡Ø± ÙˆÙÙˆØ§Ø¦Ø¯ Ø¹Ø´Ø±ÙŠÙ† Ø¨Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ù…ØµØ±Ù
13: Ø§Ø°Ø§ Ø³Ø§Ù„ Ø¹Ù† Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø§Ù„Ø¯Ø§ÙŠØ±ÙƒØª ÙÙ†ÙŠØ± Ø§Ùˆ ÙƒØ§Ù„ Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ø¯ ÙƒÙˆÙ„ Ø§Ù„Ù‡ Ù…ØªÙˆÙØ±Ù‡ Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø§Ù„Ù†Ø§Ù†Ùˆ ÙÙ†ÙŠØ± Ù‚Ø´ÙˆØ± Ù…Ø®ØªØ¨Ø±ÙŠÙ‡ Ø³Ø¹Ø± Ø§Ù„Ø³Ù† Ø§Ù„ÙˆØ§Ø­Ø¯ 50 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
14: Ø§Ù„Ø§ÙŠÙ…Ø§ÙƒØ³ Ø³Ø¹Ø±Ø© 175 Ø§Ù„Ù Ù„Ù„Ø³Ù† Ø§Ù„ÙˆØ§Ø­Ø¯ ( Ù‚Ø´ÙˆØ± Ø§Ù„Ø§ÙŠÙ…Ø§ÙƒØ³ )
15: Ø§Ø°Ø§ Ø³Ø§Ù„ Ø¹Ù† Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØµØ­ÙŠ ( Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ ØªØ´ØªØºÙ„ÙˆÙ† Ø¨Ø§Ù„Ø¶Ù…Ø§Ù† ) Ø§Ùˆ ( Ø¹Ù†Ø¯ÙƒÙ… Ø¶Ù…Ø§Ù† ØµØ­ÙŠ ) Ù‡Ù†Ø§ ÙŠÙ‚ØµØ¯ Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø­ÙƒÙˆÙ…Ù‡ ÙØ§Ù„Ø¬ÙˆØ§Ø¨ ÙŠÙƒÙˆÙ† Ø§ÙŠ Ù†Ø´ØªØºÙ„ Ø¨Ø§Ù„Ø¶Ù…Ø§Ù† Ù†Ù†Ø·ÙŠÙƒÙ… ØªÙ‚Ø±ÙŠØ± ØªØµØ¯Ù‚ÙˆÙ‡ Ø¨Ù†Ù‚Ø§Ø¨Ø© Ø§Ø·Ø¨Ø§Ø¡ Ø§Ù„Ø§Ø³Ù†Ø§Ù† ÙˆØªÙˆØ¯ÙˆÙ‡ Ù„Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠÙƒÙ…
16: Ù‚Ù„Ø¹ Ø³Ù† Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ø¬Ø±Ø§Ø­ÙŠ ( Ø§Ù„Ø³Ù† Ø§Ù„Ù…Ø·Ù…ÙˆØ± ) Ø³Ø¹Ø±Ù‡ 75 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
17: Ø§Ø°Ø§ Ø³Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨Ù†Ø¬ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§ÙŠ Ù…ØªÙˆÙØ± Ø§Ù„Ø¨Ù†Ø¬ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
18: Ø§Ø°Ø§ Ø³Ø§Ù„ Ø´Ù†Ùˆ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ† ØªØ¬Ø§ÙˆØ¨Ø© Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ† ÙˆÙ†ÙØ³ Ø§Ù„Ø´ÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø®Ø¯Ù…Ø©
19:Ù„Ø§ ØªØ¬Ø§ÙˆØ¨ Ø¨ØµÙˆØ±Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø§Ø°Ø§ Ø´ÙŠ Ù…ØªØ¹Ø±Ù ØªØ¬Ø§ÙˆØ¨Ø© ÙˆÙ…Ø§Ø¹Ù†Ø¯Ùƒ Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ù„ØºÙ‡ Ù‡Ø§ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø© Ù†Ø­Ø¯Ø¯ Ø³Ø¹Ø±Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
20: Ø³Ø¹Ø± Ø§Ù„ÙÙƒ Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ø§Ùˆ Ø§Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ù…ØªØ­Ø±Ùƒ ÙŠÙƒÙˆÙ† 40 Ø§Ù„Ù Ù„Ù„Ø³Ù† Ø§Ù„ÙˆØ§Ø­Ø¯ ( Ù„Ø§ ØªØ¹Ø·ÙŠ Ø§ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø© ØªØ®Øµ Ø§Ù„ÙÙƒ Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ø§Ù„Ù‰ ÙÙŠ Ø­ÙŠÙ† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù† Ø§Ù„ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù…ØªØ­Ø±Ùƒ )
21:- Ø§Ø°Ø§ Ù…Ø­Ø¯Ø¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¯Ø§Ø¦Ù…Ø§ Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡ÙŠØ© Ø®Ø¯Ù…Ø© Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ†  ( Ù…Ø«Ù„Ø§ ÙƒØ§Ù„ Ø´ÙƒØ¯ Ø³Ø¹Ø± Ø§Ù„ÙÙƒ Ø§Ù„ÙƒØ§Ù…Ù„ = ØªØºÙ„ÙŠÙ ÙÙƒ ÙƒØ§Ù„ Ø²Ø§Ø±ÙƒÙˆÙ† ÙˆØªÙ†Ø·ÙŠ Ø§Ù„Ø³Ø¹Ø± )
22:- Ø§Ù†Ø·ÙŠ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„ÙŠØ© Ø­Ø³Ø§Ø¨ÙŠØ© Ø¯Ø² Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
23:- Ø§ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø© Ù…Ø§ ÙÙ‡Ù…ØªÙ‡Ø§ Ø§Ùˆ Ù…Ù„ÙƒÙŠØª Ø¬ÙˆØ§Ø¨ Ø§Ù„Ù‡Ø§ ØªØ±Ø³Ù„ Ø§Ù„Ù‡ Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙˆØªØ¨Ù„ØºØ© ÙŠØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„ØªÙØ§ØµÙŠÙ„ Ø§ÙƒØ«Ø±

"""

    try:
        rsp = client.chat.completions.create(
            model="gpt-4.1",
            messages=[
                {"role": "system", "content": prompt},
                {"role": "user", "content": text}
            ],
            max_tokens=250,
            temperature=0.4
        )

        return rsp.choices[0].message.content.strip()

    except:
        return "ØµØ§Ø± Ø®Ù„Ù„ Ø¨Ø³ÙŠØ·ØŒ Ø¹Ø§ÙˆØ¯ Ø±Ø³Ø§Ù„ØªÙƒ â™¥"


# =======================================================
# ğŸ“¥ Core Handler
# =======================================================
def add_user_message(user_id, text):
    global DAILY_MESSAGES
    DAILY_MESSAGES += 1
    now = time.time()

    if text.strip() == "Faty2000":
        return

    if (
        user_id not in SESSIONS
        or (now - SESSIONS[user_id]["last_message_time"] > MEMORY_TIMEOUT)
    ):
        SESSIONS[user_id] = {
            "history": [],
            "name": "",
            "phone": "",
            "last_message_time": now,
            "followup_sent": False
        }

    st = SESSIONS[user_id]
    st["history"].append(text)
    st["last_message_time"] = now

    # Extract name
    n = extract_name(text)
    if n:
        st["name"] = n

    # Detect phone â†’ booking mode
    phone = extract_phone(text)
    if phone:
        st["phone"] = phone
        msgs = get_last_messages(user_id)
        booking = analyze_booking(st["name"], phone, msgs)

        send_message(user_id, booking["ai_message"])
        save_booking_to_sheet(booking)
        send_whatsapp_booking(
            booking["patient_name"], booking["patient_phone"],
            booking["date"], booking["time"]
        )
        return

    # otherwise â†’ chat engine
    threading.Thread(target=schedule_reply, args=(user_id,), daemon=True).start()


# =======================================================
# âœ‰ï¸ Send Message
# =======================================================
def send_message(receiver, text):
    params = {"access_token": PAGE_ACCESS_TOKEN}
    url = "https://graph.facebook.com/v18.0/me/messages"
    payload = {"recipient": {"id": receiver}, "message": {"text": text}}
    requests.post(url, params=params, json=payload)


# =======================================================
# ğŸ“¡ WEBHOOK
# =======================================================
@app.route("/webhook", methods=["GET"])
def verify():
    if request.args.get("hub.verify_token") == VERIFY_TOKEN:
        return request.args.get("hub.challenge")
    return "Error", 403


@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()
    for entry in data.get("entry", []):
        for ev in entry.get("messaging", []):
            if "message" in ev and "text" in ev["message"]:
                add_user_message(ev["sender"]["id"], ev["message"]["text"])
    return "OK", 200


# =======================================================
# RUN
# =======================================================
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)
