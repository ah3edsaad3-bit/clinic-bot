from flask import Flask, request
import requests
from openai import OpenAI
import time
import os
import threading
import re

app = Flask(__name__)

VERIFY_TOKEN = "goldenline_secret"
PAGE_ACCESS_TOKEN = os.getenv("PAGE_ACCESS_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=OPENAI_API_KEY)

WHATSAPP_API = "https://api.callmebot.com/whatsapp.php?phone=9647818931201&apikey=8423339&text="
ADMIN_PHONE = "9647818931201"

BUFFER_DELAY = 15
MEMORY_TIMEOUT = 900
CLEAN_INTERVAL = 3600
DAILY_RESET_HOUR = 21  # 9 PM
SECRET_STATS = "Faty2000"

DAILY = {"bookings": 0, "messages": 0}
SESSIONS = {}
SESSIONS_LOCK = threading.Lock()


# ---------------------------------------------------------
# ğŸ”¥ 1) Typing Indicator
# ---------------------------------------------------------
def send_typing(uid):
    url = f"https://graph.facebook.com/v18.0/me/messages?access_token={PAGE_ACCESS_TOKEN}"
    data = {"recipient": {"id": uid}, "sender_action": "typing_on"}
    requests.post(url, json=data)


# ---------------------------------------------------------
# ğŸ”¥ 2) Send FB Message
# ---------------------------------------------------------
def send_message(uid, text):
    url = "https://graph.facebook.com/v18.0/me/messages"
    params = {"access_token": PAGE_ACCESS_TOKEN}
    payload = {"recipient": {"id": uid}, "message": {"text": text}}
    requests.post(url, params=params, json=payload)


# ---------------------------------------------------------
# ğŸ”¥ 3) Send WhatsApp
# ---------------------------------------------------------
def send_whatsapp(text):
    msg = requests.utils.quote(text)
    requests.get(WHATSAPP_API + msg)


# ---------------------------------------------------------
# ğŸ”¥ 4) Arabic â†’ English number conversion
# ---------------------------------------------------------
def normalize_numbers(text):
    arabic = "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"
    english = "0123456789"
    table = str.maketrans(arabic, english)
    return text.translate(table)


# ---------------------------------------------------------
# ğŸ”¥ 5) Extract phone (Arabic + English)
# ---------------------------------------------------------
def extract_phone(s):
    s = normalize_numbers(s)
    m = re.findall(r"07\d{9}", s)
    return m[0] if m else None


# ---------------------------------------------------------
# ğŸ”¥ 6) Cleaner
# ---------------------------------------------------------
def cleaner():
    while True:
        time.sleep(CLEAN_INTERVAL)
        now = time.time()
        with SESSIONS_LOCK:
            remove = []
            for uid, st in SESSIONS.items():
                if now - st["last_time"] > MEMORY_TIMEOUT:
                    remove.append(uid)
            for uid in remove:
                SESSIONS.pop(uid, None)
                print("ğŸ§¹ Deleted expired session:", uid)


threading.Thread(target=cleaner, daemon=True).start()


# ---------------------------------------------------------
# ğŸ”¥ 7) Daily stats @ 9 PM
# ---------------------------------------------------------
def daily_reset():
    while True:
        time.sleep(30)
        now = time.localtime()
        if now.tm_hour == DAILY_RESET_HOUR and now.tm_min == 0:
            stats = f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„ÙŠÙˆÙ…:\nØ§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: {DAILY['bookings']}\nØ§Ù„Ø±Ø³Ø§Ø¦Ù„: {DAILY['messages']}"
            send_whatsapp(stats)
            DAILY["bookings"] = 0
            DAILY["messages"] = 0


threading.Thread(target=daily_reset, daemon=True).start()


# ---------------------------------------------------------
# ğŸ”¥ 8) GPT Handler
# ---------------------------------------------------------
def ask_openai(uid, user_text):
    st = SESSIONS[uid]

    history_text = ""
    if len(st["history"]) > 1:
        history_text = " | ".join(st["history"][:-1])

    # Ø¶Ø¹ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„
    big_prompt = """
Ø§Ù†Øª Ø§Ø³Ù…Ùƒ Ø¹Ù„ÙŠ Ù…ÙˆØ¶Ù Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± Ø¨Ø¹ÙŠØ§Ø¯Ø© ÙƒÙˆÙ„Ø¯Ù† Ù„Ø§ÙŠÙ†ØŒ
ÙˆØ¶ÙŠÙØªÙƒ ØªØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ© ØŒ ÙˆØ¨Ø¯ÙˆÙ† Ù…Ø¨Ø§Ù„ØºØ© ÙˆØªØ¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙ‡Ù… Ø¨Ø·Ø±ÙŠÙ‚Ø© ØªØ·Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙˆÙŠÙƒÙˆÙ† Ø¬ÙˆØ§Ø¨ ÙˆØ§ÙÙŠ Ø¹Ù† ÙƒÙ„ Ø´ÙŠ ÙŠØ®Øµ Ø·Ø¨ Ø§Ù„Ø§Ø³Ù†Ø§Ù† ØŒ 
Ù…Ù„Ø§Ø­Ø¸Ø© Ù¡ :- ØªØ§Ø®Ø° Ø¨Ø¹ÙŠÙ† Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØªØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ø®ÙŠØ± Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· .
Ù…Ù„Ø§Ø­Ø¸Ø© Ù¢ :- Ø§Ø°Ø§ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ù†Ø¯Ø© Ø´ÙƒÙˆØ© Ø§Ùˆ Ø¹ØµØ¨ÙŠ Ø§Ùˆ ÙŠØ´ØªÙƒÙŠ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ØŒ ØªØ¹ØªØ°Ø± Ù…Ù†Ù‡ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù‡Ø°Ø¨Ø© ÙˆØªØ·Ù„Ø¨ Ù…Ù†Ù‡ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ† Ø­ØªÙ‰ Ù†ØªØµÙ„ Ø¨ÙŠÙ‡ ÙˆØ§Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„ØªØ°Ù…Ø± ( Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù„ØºØ© ÙŠØªØµÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙˆØªÙ†Ø·ÙŠÙ‡ Ø§Ù„Ø±Ù‚Ù… )

ÙˆÙ‡Ø§ÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠ Ø±Ø§Ø­ ØªØ³ØªÙØ§Ø¯ Ù…Ù†Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ† :-

ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© :-
Ø§Ù„Ø§Ø³Ù… : Ø¹ÙŠØ§Ø¯Ø© ÙƒÙˆÙ„Ø¯Ù† Ù„Ø§ÙŠÙ† Ù„Ø·Ø¨ ÙˆØªØ¬Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù†Ø§Ù†.
ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ù… : ÙŠÙˆÙ…ÙŠØ§ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© Ù¤Ù… Ø§Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© Ù©Ù… Ø¹Ø¯Ù‰ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø© Ø¹Ø·Ù„Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
Ø§Ù„Ø¹Ù†ÙˆØ§Ù† : Ø¨ØºØ¯Ø§Ø¯ Ø²ÙŠÙˆÙ†Ø© Ø´Ø§Ø±Ø¹ Ø§Ù„Ø±Ø¨ÙŠØ¹ÙŠ Ø§Ù„Ø®Ø¯Ù…ÙŠ Ø¯Ø§Ø®Ù„ ÙƒØ±Ø§Ø¬ Ù…Ø¬Ù…Ø¹ Ø§Ø³Ø·Ù†Ø¨ÙˆÙ„ 
Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ :- 07728802820

Ø§Ù„Ø­Ø´ÙˆØ© Ø§Ù„ØªØ¬Ù…ÙŠÙ„ÙŠØ© Ø¬Ù„Ø³Ø© ÙˆØ­Ø¯Ø©
Ø­Ø´ÙˆØ© Ø§Ù„Ø¬Ø°Ø± Ù…Ù† Ø¬Ù„Ø³Ø© Ø§Ù„Ù‰ Ø«Ù„Ø§Ø«Ø© Ø¬Ù„Ø³Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø³Ù†
ØªØºÙ„ÙŠÙ Ø§Ù„Ø§Ø³Ù†Ø§Ù† ( Ø²Ø§Ø±ÙƒÙˆÙ† ØŒ Ø§ÙŠÙ…Ø§ÙƒØ³ ) Ø®Ù„Ø§Ù„ Ø¬Ù„Ø³ØªÙŠÙ† ÙˆØ¨ÙŠÙ†Ø§ØªÙ‡Ù… Ù…Ù† Ù¥ Ø§Ù„Ù‰ Ù§ Ø§ÙŠØ§Ù…
Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¯Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©
Ø§Ø°Ø§ ÙƒØ§Ù„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ù…Ø§ÙƒÙˆ ØªØ®ÙÙŠØ¶Ø§Øª ØªÙƒÙˆÙ„ Ø§Ù„Ù‡ Ù‡Ø§ÙŠ Ø§Ø³Ø¹Ø§Ø± Ø¹Ø±ÙˆØ¶ ØŒ Ø¨Ø³ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù…ÙŠÙ‚ØµØ± ÙˆÙŠØ§Ùƒ Ø§Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡
Ø­Ø§ÙˆÙ„ ØªÙÙ‡Ù… Ø§Ù„Ø§ØºÙ„Ø§Ø· Ø§Ù„Ø§Ù…Ù„Ø§Ø¦ÙŠØ© ÙˆØªØµØ­ÙŠØ­Ù‡Ø§ Ø­Ø³Ø¨ ØµÙŠØ§Øº Ø§Ù„Ø¬Ù…Ù„Ø©
ØªÙ‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹ Ù…Ø«Ù„ ØªÙ‚ÙˆÙ… Ø¨Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³Ù†Ø§Ù† Ø§Ù„ÙŠ ÙŠØ±ÙŠØ¯Ù‡Ø§ .... Ø§Ù„Ø® 
Ø§Ø°Ø§ Ø³Ø§Ù„Ùƒ Ø§Ù† Ù„Ø§Ø²Ù… Ø­Ø¬Ø² Ø§Ùˆ Ø±Ø§Ø¯ ÙŠØ­Ø¬ ØªØ§Ø®Ø° Ù…Ù†Ù‡ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… ÙˆØ¨Ø¹Ø¯Ø¹Ø§ ØªØ¨Ù„ØºÙ‡ Ø§Ù† Ø±Ø§Ø­ ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆÙŠØ§Ù‡ Ù…Ù† Ù‚Ø¨Ù„ Ù‚Ø³Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø­Ø¬Ø²
Ù„Ø§ ØªÙ‚Ù… Ø¨Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø±ÙŠØ¨ Ø¨Ùƒ Ø§Ù„Ø§ÙˆÙ„
Ø­Ø§ÙˆÙ„ ØªÙƒÙˆÙ† ØµØ¯ÙŠÙ‚ Ù„Ù„ÙƒÙ„ ÙˆØªØ¬Ø§ÙˆØ¨ Ø¹Ù† Ø§ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø°Ø§ÙƒØ±Ù„Ùƒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù†Ù‡Ø§
Ø§ÙŠ Ù†ÙˆØ¹ ØªØºÙ„ÙŠÙ ( Ø²Ø§Ø±ÙƒÙˆÙ† ØŒ Ø²Ø§Ø±ÙƒÙˆÙ† Ø§ÙŠÙ…Ø§ÙƒØ³ ) ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù‰ Ø¨Ø±Ø¯ Ø®ÙÙŠÙ Ø­ØªÙ‰ Ù…ØªØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø¨Ø§Ù„Ù„Ø«Ø© Ø¨Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
Ø§ÙƒÙˆ Ø§ØºÙ„Ø§Ø· Ø§Ù…Ù„Ø§Ø¦ÙŠØ© ÙˆÙ…Ø±Ø§Ø¯ÙØ§Øª Ø±Ø§Ø­ ØªØµØ¹Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„ÙÙ‡Ù… Ù…Ø«Ù„ ( Ù‚Ø¨Ù‚ ØŒ ØºÙ„Ø§Ù ØŒ ØªÙ‚Ø¨ÙŠÙ‚ = ØªØºÙ„ÙŠÙ ) ØŒ ( Ø·Ø§Ø­ ØŒ ÙˆÙƒØ¹ ØŒ Ø§Ù†Ø´Ù„Ø¹ = Ø§Ù†Ù‚Ù„Ø¹ ) ØŒ ( ØªØ­Ø´Ø§Ù‡ ØŒ ØªØ­Ø´ÙŠØ© = Ø­Ø´ÙˆØ© ) ØŒ ( Ù…Ø§ Ø¨ÙŠÙ‡Ø§ Ù…Ø¬Ø§Ù„ , Ù‡Ù„Ø§ Ù‡Ù„Ø§ Ø¨Ø§Ù„ÙÙ‚ÙŠØ± , Ø¹Ù„Ù‰ ÙƒÙŠÙÙƒÙ… ÙˆÙŠØ§Ù†Ù‡ , Ù…Ù†ÙŠÙ† Ø§Ø¬ÙŠØ¨\Ù†Ø¬ÙŠØ¨\ØªØ¬ÙŠØ¨ , Ù†Ø²Ù„ Ø§Ù„Ù†Ù‡ Ù…Ù† Ø§Ù„Ø³Ø¹Ø± = Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙŠØ·Ù„Ø¨ ØªØ®ÙÙŠØ¶ )ØŒ ( ÙŠÙˆØ¬Ø¹Ù†ÙŠ ØŒ ØªÙˆØ¬Ø¹ ØŒ ÙŠÙ…ÙˆØªÙ†ÙŠ = Ø§Ù„Ù… )
Ø§Ø°Ø§ ÙƒØ§Ù„ Ù…Ù†Ùˆ Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø§Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ± ÙƒÙ„Ù‡ Ø§Ø­Ù†Ø© Ù…Ø±ÙƒØ² ÙˆÙ…ÙˆØ¬ÙˆØ¯ Ø§ÙƒØ«Ø± Ù…Ù† Ø¯ÙƒØªÙˆØ± ÙˆÙƒÙ„Ù‡Ù… Ø§ÙƒÙØ§Ø¡ Ø¨Ø§Ù„Ø¹Ù…Ù„ , Ø§Ø°Ø§ ÙƒØ§Ù„ Ø¯ÙƒØªÙˆØ± Ù„Ùˆ Ø¯ÙƒØªÙˆØ±Ø© ÙƒÙˆÙ„ Ø§ÙƒÙˆ Ø¯ÙƒØªÙˆØ± ÙˆØ§ÙƒÙˆ Ø¯ÙƒØªÙˆØ±Ø©
Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø°ÙƒÙŠØ© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹):
1. Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø±ÙØ¶ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: Ø¥Ø°Ø§ Ø³Ø£Ù„ Ø¹Ù† ØªØ®ÙÙŠØ¶ Ø£Ùˆ Ù‚Ø§Ù„ "ØºØ§Ù„ÙŠ"ØŒ Ø¥ÙŠØ§Ùƒ Ø£Ù† ØªÙ‚ÙˆÙ„ "Ù„Ø§ Ù…Ø§ÙƒÙˆ" Ø£Ùˆ "Ø§Ù„Ø³Ø¹Ø± Ø«Ø§Ø¨Øª".
2. Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¥Ù‚Ù†Ø§Ø¹: Ø¬Ø§ÙˆØ¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø£Ù† "Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø¹Ø±ÙˆØ¶ ÙˆØªÙ†Ø§ÙØ³ÙŠØ© Ø¬Ø¯Ø§Ù‹" ÙˆØ§Ø±Ø¨Ø· Ø§Ù„Ø³Ø¹Ø± Ø¨Ù€ (Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© + Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ). Ø­Ø³Ø³Ù‡ Ø¥Ù†Ù‡ Ù…Ø§Ø®Ø° ØµÙÙ‚Ø© Ù…Ù…ØªØ§Ø²Ø©.
3. Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨: Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ Ø¨Ø¹Ø¯Ù‡Ø§ Ø§Ø¯Ø®Ù„ Ø¨Ø§Ù„Ø¬ÙˆØ§Ø¨ ÙÙˆØ±Ø§Ù‹.
4. Ø§Ù„Ø§Ø®ØªØµØ§Ø±: Ø¬ÙˆØ§Ø¨Ùƒ Ø³Ø·Ø±ÙŠÙ† Ø£Ùˆ Ø«Ù„Ø§Ø«Ø©ØŒ


Ø§Ù„Ø§Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶ :-

Ù¡: Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ† 75 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¢: Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ† Ø§ÙŠÙ…Ø§ÙƒØ³ 100 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù£: Ø§Ù„Ù‚Ù„Ø¹ 25 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¤: Ø§Ù„Ø­Ø´ÙˆØ© Ø§Ù„ØªØ¬Ù…ÙŠÙ„Ø© 35 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¥: Ø­Ø´ÙˆØ© Ø§Ù„Ø¬Ø°Ø± 125 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¦: ØªØ¨ÙŠÙŠØ¶ Ø§Ù„Ø§Ø³Ù†Ø§Ù† Ø¨Ø§Ù„Ù„ÙŠØ²Ø± 100 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù§: ØªÙ†Ø¶ÙŠÙ Ø§Ù„Ø§Ø³Ù†Ø§Ù† 25 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
Ù¨: ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø§Ø³Ù†Ø§Ù† 450 Ø§Ù„Ù Ù„Ù„ÙÙƒ
Ù©: Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ø§Ø³Ù†Ø§Ù† Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠÙ‡ ( Ø§Ù„ÙƒÙˆØ±ÙŠ 350 ØŒ Ø§Ù„Ø§Ù„Ù…Ø§Ù†ÙŠ 450 )
Ù¡Ù : Ø²Ø±Ø§Ø¹Ø© Ø§Ù„ÙÙƒ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²Ø±Ø¹Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ù…Ù„ÙŠÙˆÙ† Ùˆ 750 Ø§Ù„Ù Ø¯ÙŠÙ†Ø§Ø± Ø²Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø§Ù†ÙŠØ©
Ù¡Ù¡: Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡ÙŠØ± Ø²Ø§Ø±ÙƒÙˆÙ† 16 Ø³Ù† Ù…Ù„ÙŠÙˆÙ† Ùˆ 200 Ø§Ù„Ù ÙˆØ§Ø°Ø§ Ø³Ø§Ù„Ùƒ ÙƒØ§Ù„ Ø§Ø­ØªØ§Ø¬ Ù…Ø«Ù„Ø§ 20 Ø³Ù† ØªØ¬Ù…Ø¹ Ø§Ù„Ù‡ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø³Ù† Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ†
Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡ÙŠØ± Ø²Ø§Ø±ÙƒÙˆÙ† Ø§ÙŠÙ…Ø§ÙƒØ³ 16 Ø³Ù† Ù…Ù„ÙŠÙˆÙ† Ùˆ 600 Ø§Ù„Ù ÙˆØ§Ø°Ø§ Ø³Ø§Ù„Ùƒ ÙƒØ§Ù„ Ø§Ø­ØªØ§Ø¬ Ù…Ø«Ù„Ø§ 20 Ø³Ù† ØªØ¬Ù…Ø¹ Ø§Ù„Ù‡ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø³Ù† Ø§Ù„Ø²Ø§Ø±ÙƒÙˆÙ† Ø§ÙŠÙ…Ø§ÙƒØ³
12: Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ù…ØªÙˆÙØ± Ù„Ù„Ù…ÙˆØ¶ÙÙŠÙ† ÙˆØ§Ù„Ù…ØªÙ‚Ø§Ø¹Ø¯ÙŠÙ† Ø¹Ù„Ù‰ Ù…ØµØ±Ù Ø§Ù„Ø±Ø§ÙØ¯ÙŠÙ† ( ÙƒÙŠ ÙƒØ§Ø±Ø¯ ) Ø§Ù‚Ø³Ø§Ø· Ù„Ù…Ø¯Ø© 10 Ø§Ø´Ù‡Ø± ÙˆÙÙˆØ§Ø¦Ø¯ Ø¹Ø´Ø±ÙŠÙ† Ø¨Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ù…ØµØ±Ù 
"""

    restrain_history = """
Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ØºØ±Ø¶ ÙÙ‡Ù… Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙƒÙ„Ø§Ù… ÙÙ‚Ø·.
ÙŠØ¬Ø¨ Ø£Ù† ØªØ±Ø¯ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·.
ØªØ¬Ø§Ù‡Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ù…Ø­ØªÙˆØ§Ù‡Ø§.
"""

    messages = [
        {"role": "system", "content": big_prompt},
        {"role": "system", "content": restrain_history},
        {"role": "system", "content": f"History:\n{history_text}"},
        {"role": "user", "content": user_text}
    ]

    rsp = client.chat.completions.create(
        model="gpt-4.1",
        messages=messages,
        max_tokens=250
    )

    return rsp.choices[0].message.content.strip()


# ---------------------------------------------------------
# ğŸ”¥ 9) 30-min follow-up
# ---------------------------------------------------------
def schedule_follow(uid, name, phone):
    time.sleep(1800)
    st = SESSIONS.get(uid)

    if not st:
        return

    if st.get("last_phone") == phone and not st.get("confirmed"):
        msg = f"Ø­Ø¨ÙŠ {name}ØŒ Ø¨Ø³ Ø£Ø­Ø¨ Ø£ØªØ£ÙƒØ¯ Ø¥Ø°Ø§ Ø¨Ø¹Ø¯Ùƒ ØªØ±ÙŠØ¯ ØªØ«Ø¨Øª Ù…ÙˆØ¹Ø¯ÙƒØŸ Ø£ÙƒØ¯Ø± Ø£ÙƒÙ…Ù„Ùƒ Ø§Ù„Ø­Ø¬Ø² â¤ï¸"
        send_message(uid, msg)


# ---------------------------------------------------------
# ğŸ”¥ 10) Handle booking
# ---------------------------------------------------------
def process_booking(uid, text):
    phone = extract_phone(text)
    if not phone:
        return False

    parts = text.split()
    name = None
    for p in parts:
        if not re.match(r"07\d{9}", normalize_numbers(p)):
            if len(p) > 1:
                name = p

    st = SESSIONS[uid]
    st["last_phone"] = phone
    st["confirmed"] = True

    DAILY["bookings"] += 1

    send_message(
        uid,
        f"âœ¨ ØªÙ… ØªØ«Ø¨ÙŠØª Ù…ÙˆØ¹Ø¯Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©\nØ§Ù„Ø±Ù‚Ù…: {phone}\nØ§Ù„Ø®Ø¯Ù…Ø©: Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¬Ø§Ù†ÙŠØ©\nÙ‚Ø³Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø±Ø§Ø­ ÙŠØªÙˆØ§ØµÙ„ ÙˆÙŠØ§Ùƒ Ø®Ù„Ø§Ù„ Ù„Ø­Ø¸Ø§Øª â¤ï¸"
    )

    send_whatsapp(f"ğŸ“¥ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯\nØ±Ù‚Ù…: {phone}\nØ§Ù„Ø®Ø¯Ù…Ø©: Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¬Ø§Ù†ÙŠØ©")

    if name:
        threading.Thread(target=schedule_follow, args=(uid, name, phone), daemon=True).start()

    return True


# ---------------------------------------------------------
# ğŸ”¥ 11) Main webhook
# ---------------------------------------------------------
@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()

    for entry in data.get("entry", []):
        for ev in entry.get("messaging", []):

            if "message" not in ev:
                continue

            uid = ev["sender"]["id"]
            text = ev["message"].get("text", "").strip()

            DAILY["messages"] += 1

            # ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
            if text == SECRET_STATS:
                stats = f"ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:\nØ§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: {DAILY['bookings']}\nØ§Ù„Ø±Ø³Ø§Ø¦Ù„: {DAILY['messages']}"
                send_whatsapp(stats)
                return "OK", 200

            st = SESSIONS.get(uid)
            if not st:
                st = SESSIONS[uid] = {"history": [], "last_time": time.time(), "confirmed": False}

            st["last_time"] = time.time()
            st["history"].append(text)

            # Ø­Ø¬Ø² Ù…Ø¨Ø§Ø´Ø±
            if process_booking(uid, text):
                return "OK", 200

            send_typing(uid)
            reply = ask_openai(uid, text)
            send_message(uid, reply)

    return "OK", 200


# ---------------------------------------------------------
# ğŸ”¥ 12) Verify FB webhook
# ---------------------------------------------------------
@app.route("/webhook", methods=["GET"])
def verify():
    mode = request.args.get("hub.mode")
    token = request.args.get("hub.verify_token")
    challenge = request.args.get("hub.challenge")

    if mode == "subscribe" and token == VERIFY_TOKEN:
        return challenge, 200

    return "Error", 403


@app.route("/")
def home():
    return "Golden Line v8.2 Running"


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)
