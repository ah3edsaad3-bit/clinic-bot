from flask import Flask, request
import requests
from openai import OpenAI
import time
import os
import threading

app = Flask(__name__)

# ==============================
# 1) Tokens
# ==============================

VERIFY_TOKEN = "goldenline_secret"
PAGE_ACCESS_TOKEN = os.getenv("PAGE_ACCESS_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

client = OpenAI(api_key=OPENAI_API_KEY)

# ==============================
# 2) Sessions Memory
# ==============================

SESSIONS = {}
BUFFER_DELAY = 15
MEMORY_TIMEOUT = 900   # 15 minutes


# ==============================
# 3) Schedule (15 sec merge)
# ==============================

def schedule_reply(user_id):
    time.sleep(BUFFER_DELAY)

    state = SESSIONS.get(user_id)
    if state is None:
        return

    now = time.time()

    # ุฅุฐุง ูุง ูุตูุช ุฑุณุงูุฉ ุฌุฏูุฏุฉ ุฎูุงู 15 ุซุงููุฉ โ ูุฑุฏ
    if (now - state["last_message_time"]) >= BUFFER_DELAY:
        try:
            reply = ask_openai(user_id)
        except Exception as e:
            print("โ OpenAI Error:", e)
            reply = "ุตุงุฑ ุฎูู ุจุณูุทุ ุฌุฑุจ ูุฑุฉ ุซุงููุฉ ๐"

        send_message(user_id, reply)


# ==============================
# 4) Add Message + Memory 15 min
# ==============================

def add_user_message(user_id, text):
    now = time.time()

    # ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ ุฅุฐุง ูุฏููุฉ ุฃู ุบูุฑ ููุฌูุฏุฉ
    if user_id not in SESSIONS or (now - SESSIONS[user_id]["last_message_time"] > MEMORY_TIMEOUT):
        SESSIONS[user_id] = {
            "messages": [],
            "last_message_time": now
        }

    SESSIONS[user_id]["messages"].append(text)
    SESSIONS[user_id]["last_message_time"] = now

    # ุชุดุบูู ูุคูุช ุงูุฏูุฌ
    t = threading.Thread(target=schedule_reply, args=(user_id,))
    t.start()


# ==============================
# 5) AI โ ุขุฎุฑ ุฑุณุงูุฉ ููุท + ุณูุงู ุฎููู
# ==============================

def ask_openai(user_id):
    msgs = SESSIONS[user_id]["messages"]

    # ุขุฎุฑ ุฑุณุงูุฉ ููุท
    last_message = msgs[-1]

    # ุงูุชุงุฑูุฎ ุงูุณุงุจู ูุฎูููุฉ ููุท
    if len(msgs) > 1:
        history = " | ".join(msgs[:-1])
    else:
        history = ""

    system_prompt = """
ุงูุช ุงุณูู "ุนูู" ููุธูู ุงูููู ุณูุชุฑ ูู ุนูุงุฏุฉ ูููุฏู ูุงูู ูุทุจ ูุชุฌููู ุงูุฃุณูุงู.
ูุธููุชู ุงูุฑุฏ ุจุงูููุฌุฉ ุงูุนุฑุงููุฉ ุจุงุญุชุฑุงู ูุจุฏูู ูุจุงูุบุฉุ ูุชุทููู ุงููุฑุงุฌุน ูุชุฌุงูุจ ุจุงุฎุชุตุงุฑ ูุงุถุญ ููููู.

ููุงุนุฏ ุงูุฑุฏ:
- ุชุฌุงูุจ ุนูู **ุขุฎุฑ ุฑุณุงูุฉ ููุท**.
- ุชุณุชุฎุฏู ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ ููุท ูููููุ ุจุฏูู ูุง ุชุนูุฏ ุงูุดุฑุญ.
- ุฑุฏูุฏู ูุฎุชุตุฑุฉ (ุณุทุฑูู ุฃู ุซูุงุซุฉ).
- ุงูุชุฑุญูุจ ููุท ุฅุฐุง ุงููุฑุงุฌุน ุฑุญูุจ ุจูู.
- ุจุฏูู ูุจุงูุบุฉ ุฃู ุฃุณููุจ ุชุฌุงุฑู.
- ุฅุฐุง ุฃูู ุฎุทุฃ ุฅููุงุฆู ุชุชุฌุงูุฒู ูุชููู ุงูุตูุงุบุฉ.
- ุฅุฐุง ุงููุฑุงุฌุน ุนูุฏู ูุดููุฉ ููู ุงูุนูุงุฏุฉ: ุชูุทูู ุงูุฑูู ูุจุงุดุฑุฉ:
  "ุญุจูุจู ูุฐุง ุฑูู ุงูุนูุงุฏุฉ ุญุชู ูุชูุงุตููู ููุงู ูุจุงุดุฑุฉ: 07728802820"
- ุฅุฐุง ูุฑูุฏ ูุญุฌุฒุ ุชุทูุจ ููู ุงูุงุณู ูุงูุฑูู:
  "ุชูุงู ุญุจูุจูุ ุญุชู ุฃูููู ุงูุญุฌุฒ ุฏุฒูู ุงุณูู ูุฑููู."
- ูุฅุฐุง ุฏุฒููุ ุชุฑุฌุนูู:
  "ุชุฃููุฏ ุงูุญุฌุฒ:
   ุงูุงุณู: โฆ
   ุงูุฑูู: โฆ
   ุฑุงุญ ูุชู ุงูุชูุงุตู ููุงู ูู ูุจู ูุณู ุงููุชุงุจุนุฉ ูุชุญุฏูุฏ ููุนุฏ ุงูุญุฌุฒ."

ุชูุงุตูู ุงูุนูุงุฏุฉ:
- ุงูุงุณู: ุนูุงุฏุฉ ูููุฏู ูุงูู ูุทุจ ูุชุฌููู ุงูุฃุณูุงู
- ุงูุนููุงู: ุจุบุฏุงุฏ โ ุฒูููุฉ โ ุดุงุฑุน ุงูุฑุจูุนู ุงูุฎุฏูู โ ุฏุงุฎู ูุฑุงุฌ ูุฌูุน ุฅุณุทูุจูู
- ุงูุฏูุงู: ููููุงู ูู 4 ูุณุงุกู ุฅูู 9 ูุณุงุกู
- ุงูุฌูุนุฉ ุนุทูุฉ
- ุฑูู ุงููุงุชู: 07728802820

ูุนูููุงุช ุทุจูุฉ:
- ุงูุญุดูุฉ ุงูุชุฌููููุฉ ุฌูุณุฉ ูุญุฏุฉ.
- ุญุดูุฉ ุงูุฌุฐุฑ: ูู ุฌูุณุฉ ุฅูู 3 ุญุณุจ ุงูุงูุชูุงุจ.
- ุงูุชุบููู (ุฒุงุฑููู โ ุฃููุงูุณ): ุฌูุณุชููุ ุจูููู 5โ7 ุฃูุงู.
- ุถูุงู ุงูุนูุงุฏุฉ: ุฌูุฏุฉ ุงูุนูู ูุฏู ุงูุญูุงุฉ.
- ุงูุชุบููู ูุญุชุงุฌ ุจุฑุฏ ุฎููู ููุณู ุญุชู ูุง ูุตูุฑ ูุดุงูู ุจุงููุซุฉ.

ููุฑุฏุงุช ุฏุงุฑุฌุฉ ูุฌุจ ูุนุฑูุฉ ูุนูุงูุง:
(ูุจูุ ุบูุงูุ ุชูุจูู = ุชุบููู)
(ุทุงุญุ ููุนุ ุงูุดูุน = ุงูููุน)
(ุชุญุดุงูุ ุชุญุดูุฉ = ุญุดูุฉ)
(ููุฌุนููุ ุชูุฌุนุ ูููุชูู = ุฃูู)

ููุงุนุฏ ุงูุฑุฏ ุนูู ุงูุฃุณุนุงุฑ:
1. ููููุน ุงูุฑูุถ ุงููุจุงุดุฑ.
2. ุฅุฐุง ุณุฃู ุนู ุชุฎููุถ: 
   "ุญุจูุจู ูุงู ุงูุฃุณุนุงุฑ ุฃุณุนุงุฑ ุนุฑูุถ ูููุงูุณุฉุ ูุงูููุงุฏ ุฃููุงููุฉ ูุงูุถูุงู ุญูููู."
3. ุชุฑุจุท ุงูุณุนุฑ ุจุงูุฌูุฏุฉ ูุงูุถูุงู.

ุงูุฃุณุนุงุฑ ุงูุฑุณููุฉ:
- ุชุบููู ุฒุงุฑููู: 75,000
- ุชุบููู ุฒุงุฑููู ุฃููุงูุณ: 100,000
- ุงูููุน: 25,000
- ุงูุญุดูุฉ ุงูุชุฌููููุฉ: 35,000
- ุญุดูุฉ ุงูุฌุฐุฑ: 125,000
- ุชุจููุถ ุงูุฃุณูุงู: 100,000
- ุชูุธูู ุงูุฃุณูุงู: 25,000
- ุชูููู ุงูุฃุณูุงู: 450,000 ูููู
- ุฒุฑุงุนุฉ ุงูุฃุณูุงู ุงูุชูููุฏูุฉ:
   โข ููุฑู: 350,000
   โข ุฃููุงูู: 450,000
- ุฒุฑุงุนุฉ ุงููู ุงููุงูู (ุฒุฑุนุงุช ููุฑูุฉ โ ุฃููุงูู): 1,750,000
- ุงุจุชุณุงูุฉ ุงููุดุงููุฑ ุฒุงุฑููู (16 ุณู): 1,200,000
- ุงุจุชุณุงูุฉ ุงููุดุงููุฑ ุฒุงุฑููู ุฃููุงูุณ (16 ุณู): 1,600,000
ุฅุฐุง ุทูุจ ุญุณุงุจ 20 ุณูุ ุชุฌูุนู ุญุณุจ ุงูุณุนุฑ.

ูุฏูู:
- ุชููู ุตุฏูู ูููุฑุงุฌุน.
- ุชุฌุงูุจ ุจุซูุฉ ูุจุฏูู ุชูุฑุงุฑ.
- ุชุฑููุฒ ุนูู ุขุฎุฑ ุฑุณุงูุฉ ููุท.
"""

    rsp = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_prompt},
            {
                "role": "assistant",
                "content": f"ุฎูููุฉ ุงููุญุงุฏุซุฉ ุงูุณุงุจูุฉ: {history}"
            },
            {
                "role": "user",
                "content": last_message
            }
        ],
        max_tokens=250
    )

    return rsp.choices[0].message.content.strip()


# ==============================
# 6) Webhook Endpoints
# ==============================

@app.route("/", methods=["GET"])
def home():
    return "GoldenLine bot โ Reply only to last message โ Memory OK"


@app.route("/webhook", methods=["GET"])
def verify():
    mode = request.args.get("hub.mode")
    token = request.args.get("hub.verify_token")
    challenge = request.args.get("hub.challenge")

    if mode == "subscribe" and token == VERIFY_TOKEN:
        return challenge, 200

    return "Error", 403


@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()
    print("๐ฉ Incoming:", data)

    for entry in data.get("entry", []):
        for ev in entry.get("messaging", []):
            sender = ev["sender"]["id"]

            if "message" in ev and "text" in ev["message"]:
                text = ev["message"]["text"]
                add_user_message(sender, text)

    return "OK", 200


# ==============================
# 7) Facebook Reply
# ==============================

def send_message(receiver, text):
    url = "https://graph.facebook.com/v18.0/me/messages"
    params = {"access_token": PAGE_ACCESS_TOKEN}
    payload = {
        "recipient": {"id": receiver},
        "message": {"text": text}
    }

    requests.post(url, params=params, json=payload)


# ==============================
# Render Server
# ==============================

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)
