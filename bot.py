from flask import Flask, request
import requests
from openai import OpenAI
import time
import os
import threading

app = Flask(__name__)

# Tokens
VERIFY_TOKEN = "goldenline_secret"
PAGE_ACCESS_TOKEN = os.getenv("PAGE_ACCESS_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

client = OpenAI(api_key=OPENAI_API_KEY)

# Sessions
SESSIONS = {}

BUFFER_DELAY = 15
MEMORY_TIMEOUT = 900  # 15 min

# ูุงุชุณุงุจ ุซุงุจุช
WHATSAPP_URL = "https://api.callmebot.com/whatsapp.php?phone=9647818931201&apikey=8423339&text="


# ============================================================
#     ๐งน ุชูุธูู ุฐุงุชู ูู ุณุงุนุฉ
# ============================================================
def cleaner_daemon():
    while True:
        now = time.time()
        for uid in list(SESSIONS.keys()):
            if now - SESSIONS[uid]["last_message_time"] > 3600:
                del SESSIONS[uid]
        time.sleep(3600)

threading.Thread(target=cleaner_daemon, daemon=True).start()


# ============================================================
#     ๐ ุงุณุชุฎุฑุงุฌ ุงูุฑูู ุจุงูุดุฑูุท (ูุจุฏู 07 ูุทููู 11)
# ============================================================
def extract_phone(text):
    for word in text.split():
        w = word.strip()
        if w.startswith("07") and len(w) == 11 and w.isdigit():
            return w
    return None


# ============================================================
#     ๐ ุงุณุชุฎุฑุงุฌ ุงุณู (ุฅุฐุง ููุฌูุฏ)
# ============================================================
def extract_name(text):
    cleaned = ''.join([c if not c.isdigit() else ' ' for c in text])
    if any('\u0600' <= c <= '\u06FF' for c in cleaned) and " " in cleaned:
        return cleaned.strip()
    return None


# ============================================================
#     ๐ ุฅุฑุณุงู ุงูุญุฌุฒ ูููุงุชุณุงุจ
# ============================================================
def send_whatsapp_booking(name, phone):
    msg = f"ุญุฌุฒ ุฌุฏูุฏ:\nุงูุงุณู: {name}\nุงูุฑูู: {phone}\nุงูุฎุฏูุฉ: ูุนุงููุฉ ูุฌุงููุฉ"
    url = WHATSAPP_URL + requests.utils.quote(msg)
    requests.get(url)


# ============================================================
#     ๐ฌ ุฏูุฌ ุงูุฑุณุงุฆู 15 ุซุงููุฉ
# ============================================================
def schedule_reply(user_id):
    time.sleep(BUFFER_DELAY)

    st = SESSIONS.get(user_id)
    if not st:
        return

    now = time.time()
    if now - st["last_message_time"] >= BUFFER_DELAY:

        combined_text = st["history"][-1] if st["history"] else ""
        reply = ask_openai(user_id, combined_text)
        send_message(user_id, reply)


# ============================================================
#     โ ุฅุถุงูุฉ ุฑุณุงูุฉ ูุณุชุฎุฏู
# ============================================================
def add_user_message(user_id, text):

    now = time.time()

    if user_id not in SESSIONS or (now - SESSIONS[user_id]["last_message_time"] > MEMORY_TIMEOUT):
        SESSIONS[user_id] = {
            "history": [],
            "name": "",
            "phone": "",
            "last_message_time": now
        }

    st = SESSIONS[user_id]
    st["history"].append(text)
    st["last_message_time"] = now

    # ============================================================
    #   ๐ฅ ุงูุญุฌุฒ ุงูููุฑู ุจูุฌุฑุฏ ุธููุฑ ุฑูู ุตุญูุญ
    # ============================================================
    phone = extract_phone(text)
    name = extract_name(text)

    if phone:
        final_name = name if name else (st["name"] if st["name"] else "ุจุฏูู ุงุณู")

        st["phone"] = phone
        st["name"] = final_name

        # ุฅุฑุณุงู ูุงุชุณุงุจ
        send_whatsapp_booking(final_name, phone)

        # ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฃููุฏ
        send_message(
            user_id,
            f"ุชู ุชุซุจูุช ููุนุฏู ูุจุงุดุฑุฉ ๐\n"
            f"ุงูุงุณู: {final_name}\n"
            f"ุงูุฑูู: {phone}\n"
            "ุงูุฎุฏูุฉ: ูุนุงููุฉ ูุฌุงููุฉ\n"
            "ูุณู ุงููุชุงุจุนุฉ ุฑุงุญ ูุชูุงุตู ููุงู ุฎูุงู ูุญุธุงุช โค๏ธ"
        )

        return

    # ============================================================
    #     ุฅุฐุง ูู ุฑูู โ ูุฑูุญ ููุฐูุงุก ุงูุตูุงุนู
    # ============================================================
    threading.Thread(target=schedule_reply, args=(user_id,)).start()


# ============================================================
#     ๐ค GPT RESPONSE โ ุงููุณุชุฑู ููุฑุงุฌุนุฉ ููุท
# ============================================================
def ask_openai(user_id, combined_text):
    st = SESSIONS[user_id]

    # ุงููุณุชุฑู ููุฑุณู ูู SYSTEM ููุท ููุง ููุนุงูู ูุฑุณุงุฆู ูุณุชุฎุฏู
    history_text = " | ".join(st["history"][:-1])  # ุจุฏูู ุขุฎุฑ ุฑุณุงูุฉ

    # ============================================================
    #     ๐ ุงูู PROMPT ููุง ุฃุฑุณูุชู ุฃูุช ุญุฑููุงู ุจุฏูู ุฃู ุชุนุฏูู
    # ============================================================
    big_prompt = """
ุงูุช ุงุณูู ุนูู ููุถู ุงูููู ุณูุชุฑ ุจุนูุงุฏุฉ ูููุฏู ูุงููุ
ูุถููุชู ุชุฑุฏ ุนูู ุงูุฑุณุงุฆู ุจุงูููุฌุฉ ุงูุนุฑุงููุฉ ุ ูุจุฏูู ูุจุงูุบุฉ ูุชุฌุงูุจ ุนูู ุฌููุน ุงุณุชูุณุงุฑุงุชูู ุจุทุฑููุฉ ุชุทูู ุงููุฑุงุฌุน ููููู ุฌูุงุจ ูุงูู ุนู ูู ุดู ูุฎุต ุทุจ ุงูุงุณูุงู ุ 
ููุงุญุธุฉ ูก :- ุชุงุฎุฐ ุจุนูู ุงูุงุนุชุจุงุฑ ุชุงุฑูุฎ ุงููุญุงุฏุซุฉ ุงููุฑุณู ูุน ุงููุญุงุฏุซุฉ ูุชุฑุฏ ุนูู ุงุฎูุฑ ุฑุณุงูุฉ ููุท .
ููุงุญุธุฉ ูข :- ุงุฐุง ุงููุฑุงุฌุน ุนูุฏุฉ ุดููุฉ ุงู ุนุตุจู ุงู ูุดุชูู ูู ุนูู ุงูุนูุงุฏุฉ ุ ุชุนุชุฐุฑ ููู ุจุทุฑููุฉ ููุฐุจุฉ ูุชุทูุจ ููู ุงูุงุณู ูุฑูู ุงูุชูููู ุญุชู ูุชุตู ุจูู ูุงุฐุง ุงุณุชูุฑ ุจุงูุชุฐูุฑ ( ูุจุงุดุฑุฉ ุจูุบุฉ ูุชุตู ุนูู ุฑูู ุงูุนูุงุฏุฉ ูุชูุทูู ุงูุฑูู )

ููุงู ุจุนุถ ุงูููุงุญุธุงุช ุงูู ุฑุงุญ ุชุณุชูุงุฏ ูููุง ุนูุฏ ุงูุฑุฏ ุนูู ุงููุฑุงุฌุนูู :-

ุชูุงุตูู ุงูุนูุงุฏุฉ :-
ุงูุงุณู : ุนูุงุฏุฉ ูููุฏู ูุงูู ูุทุจ ูุชุฌููู ุงูุงุณูุงู.
ููุช ุงูุฏูุงู : ููููุง ูู ุงูุณุงุนุฉ ูคู ุงูู ุงูุณุงุนุฉ ูฉู ุนุฏู ููู ุงูุฌูุนุฉ ุนุทูุฉ ุงูุนูุงุฏุฉ
ุงูุนููุงู : ุจุบุฏุงุฏ ุฒูููุฉ ุดุงุฑุน ุงูุฑุจูุนู ุงูุฎุฏูู ุฏุงุฎู ูุฑุงุฌ ูุฌูุน ุงุณุทูุจูู 
ุฑูู ุงููุงุชู :- 07728802820

ุงูุญุดูุฉ ุงูุชุฌููููุฉ ุฌูุณุฉ ูุญุฏุฉ
ุญุดูุฉ ุงูุฌุฐุฑ ูู ุฌูุณุฉ ุงูู ุซูุงุซุฉ ุฌูุณุงุช ุญุณุจ ุงูุชูุงุจ ุงูุณู
ุชุบููู ุงูุงุณูุงู ( ุฒุงุฑููู ุ ุงููุงูุณ ) ุฎูุงู ุฌูุณุชูู ูุจููุงุชูู ูู ูฅ ุงูู ูง ุงูุงู
ุถูุงู ุงูุนูุงุฏุฉ ุฌูุฏุฉ ุงูุนูู ูุฏู ุงูุญูุงุฉ
ุงุฐุง ูุงู ุงููุฑุงุฌุน ูุงูู ุชุฎููุถุงุช ุชููู ุงูู ูุงู ุงุณุนุงุฑ ุนุฑูุถ ุ ุจุณ ุงูุทุจูุจ ูููุตุฑ ููุงู ุงู ุดุงุก ุงููู
ุญุงูู ุชููู ุงูุงุบูุงุท ุงูุงููุงุฆูุฉ ูุชุตุญูุญูุง ุญุณุจ ุตูุงุบ ุงูุฌููุฉ
ุชููู ุจุชุญููู ุงูุทูุจ ุงูุฎุงุต ูููุฑุงุฌุน ูุซู ุชููู ุจุฌูุน ุงููุจูุบ ุงูููู ูููุฑุงุฌุน ุญุณุจ ุนุฏุฏ ุงูุงุณูุงู ุงูู ูุฑูุฏูุง .... ุงูุฎ 
ุงุฐุง ุณุงูู ุงู ูุงุฒู ุญุฌุฒ ุงู ุฑุงุฏ ูุญุฌ ุชุงุฎุฐ ููู ุงูุงุณู ูุงูุฑูู ูุจุนุฏุนุง ุชุจูุบู ุงู ุฑุงุญ ูุชู ุงูุชูุงุตู ููุงู ูู ูุจู ูุณู ุงููุชุงุจุนุฉ ูู ุงูุนูุงุฏุฉ ูุชุญุฏูุฏ ููุนุฏ ุงูุญุฌุฒ
ูุง ุชูู ุจุงูุชุฑุญูุจ ููุท ุนูุฏูุง ูููู ุจุงูุชุญุฑูุจ ุจู ุงูุงูู
ุญุงูู ุชููู ุตุฏูู ูููู ูุชุฌุงูุจ ุนู ุงู ุงุณุชูุณุงุฑ ุจุทุฑููุฉ ุงุญุชุฑุงููุฉ ุญุชู ูู ูุฐุงูุฑูู ูุนูููุงุช ุนููุง
ุงู ููุน ุชุบููู ( ุฒุงุฑููู ุ ุฒุงุฑููู ุงููุงูุณ ) ูุญุชุงุฌ ุงูู ุจุฑุฏ ุฎููู ุญุชู ูุชุณุจุจ ูุดุงูู ุจุงููุซุฉ ุจุงููุณุชูุจู
ุงูู ุงุบูุงุท ุงููุงุฆูุฉ ููุฑุงุฏูุงุช ุฑุงุญ ุชุตุนุจ ุนููู ุงูููู ูุซู ( ูุจู ุ ุบูุงู ุ ุชูุจูู = ุชุบููู ) ุ ( ุทุงุญ ุ ููุน ุ ุงูุดูุน = ุงูููุน ) ุ ( ุชุญุดุงู ุ ุชุญุดูุฉ = ุญุดูุฉ ) ุ ( ููุฌุนูู ุ ุชูุฌุน ุ ูููุชูู = ุงูู )

ููุงุนุฏ ุงูุฑุฏ ุงูุฐููุฉ (ููู ุฌุฏุงู):
1. ููููุน ุงูุฑูุถ ุงููุจุงุดุฑ: ุฅุฐุง ุณุฃู ุนู ุชุฎููุถ ุฃู ูุงู "ุบุงูู"ุ ุฅูุงู ุฃู ุชููู "ูุง ูุงูู" ุฃู "ุงูุณุนุฑ ุซุงุจุช".
2. ุณูุงุณุฉ ุงูุฅููุงุน: ุฌุงูุจ ุฏุงุฆูุงู ุจุฃู "ุงูุฃุณุนุงุฑ ุงูุญุงููุฉ ูู ุฃุณุนุงุฑ ุนุฑูุถ ูุชูุงูุณูุฉ ุฌุฏุงู" ูุงุฑุจุท ุงูุณุนุฑ ุจู (ุงูููุงุฏ ุงูุฃููุงููุฉ + ุงูุถูุงู ุงูุญูููู). ุญุณุณู ุฅูู ูุงุฎุฐ ุตููุฉ ููุชุงุฒุฉ.
3. ุนุฏู ุชูุฑุงุฑ ุงูุชุฑุญูุจ: ุงูุชุฑุญูุจ ูุฑุฉ ูุงุญุฏุฉ ููุทุ
 ุจุนุฏูุง ุงุฏุฎู ุจุงูุฌูุงุจ ููุฑุงู.
4. ุงูุงุฎุชุตุงุฑ: ุฌูุงุจู ุณุทุฑูู ุฃู ุซูุงุซุฉุ

ุงูุงุณุนุงุฑ ูุงูุนุฑูุถ :-

 ูก: ุงูุฒุงุฑููู 75 ุงูู ุฏููุงุฑ
ูข: ุงูุฒุงุฑููู ุงููุงูุณ 100 ุงูู ุฏููุงุฑ
ูฃ: ุงูููุน 25 ุงูู ุฏููุงุฑ
ูค: ุงูุญุดูุฉ ุงูุชุฌูููุฉ 35 ุงูู ุฏููุงุฑ
ูฅ: ุญุดูุฉ ุงูุฌุฐุฑ 125 ุงูู ุฏููุงุฑ
ูฆ: ุชุจููุถ ุงูุงุณูุงู ุจุงูููุฒุฑ 100 ุงูู ุฏููุงุฑ
ูง: ุชูุถูู ุงูุงุณูุงู 25 ุงูู ุฏููุงุฑ
ูจ: ุชูููู ุงูุงุณูุงู 450 ุงูู ูููู
ูฉ: ุฒุฑุงุนุฉ ุงูุงุณูุงู ุงูุชูููุฏูู ( ุงูููุฑู 350 ุ ุงูุงููุงูู 450 )
ูกู: ุฒุฑุงุนุฉ ุงููู ุงููุงูู ููุฒุฑุนุงุช ุงูููุฑูุฉ ููููู ู 750 ุงูู ุฏููุงุฑ ุฒุฑุนุงุช ุงููุงููุฉ
ูกูก: ุงุจุชุณุงูุฉ ุงููุดุงููุฑ ุฒุงุฑููู 16 ุณู ููููู ู 200 ุงูู ูุงุฐุง ุณุงูู ูุงู ุงุญุชุงุฌ ูุซูุง 20 ุณู ุชุฌูุน ุงูู ุงูุนุฏุฏ ุงูููู ุจูุงุก ุนูู ุณุนุฑ ุณู ุงูุฒุงุฑููู
ุงุจุชุณุงูุฉ ุงููุดุงููุฑ ุฒุงุฑููู ุงููุงูุณ 16 ุณู ููููู ู 600 ุงูู ูุงุฐุง ุณุงูู ูุงู ุงุญุชุงุฌ ูุซูุง 20 ุณู ุชุฌูุน ุงูู ุงูุนุฏุฏ ุงูููู ุจูุงุก ุนูู ุณุนุฑ ุณู ุงูุฒุงุฑููู ุงููุงูุณ
"""

    messages = [
        {"role": "system", "content": big_prompt},

        # ุงูุชุงุฑูุฎ ููุฑุงุฌุนุฉ System ููุท โ ูุง ููุฑุฏ ุนููู ููุงุฆูุงู
        {"role": "system", "content": f"ูุฐุง history ูููู ุงูุณูุงู ููุท:\n{history_text}"},

        # ุขุฎุฑ ุฑุณุงูุฉ ููุท
        {"role": "user", "content": combined_text}
    ]

    rsp = client.chat.completions.create(
        model="gpt-4.1",
        messages=messages,
        max_tokens=300
    )

    return rsp.choices[0].message.content.strip()


# ============================================================
#     FB ROUTES
# ============================================================

@app.route("/", methods=["GET"])
def home():
    return "GoldenLine v5.8 Running"

@app.route("/webhook", methods=["GET"])
def verify():
    mode = request.args.get("hub.mode")
    token = request.args.get("hub.verify_token")
    challenge = request.args.get("hub.challenge")

    if mode == "subscribe" and token == VERIFY_TOKEN:
        return challenge, 200

    return "Error", 403


@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()
    print("Incoming:", data)

    for entry in data.get("entry", []):
        for ev in entry.get("messaging", []):
            sender = ev["sender"]["id"]

            if "message" in ev and "text" in ev["message"]:
                add_user_message(sender, ev["message"]["text"])

    return "OK", 200


# ============================================================
#     ุฅุฑุณุงู ุฑุณุงูุฉ ูููุณุจูู
# ============================================================
def send_message(receiver, text):
    url = "https://graph.facebook.com/v18.0/me/messages"
    params = {"access_token": PAGE_ACCESS_TOKEN}
    payload = {
        "recipient": {"id": receiver},
        "message": {"text": text}
    }
    r = requests.post(url, params=params, json=payload)
    print("FB Response:", r.text)


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)
