from flask import Flask, request
import requests
from openai import OpenAI
import time
import os
import threading
import re

app = Flask(__name__)

# =======================================================
# ๐ TOKENS
# =======================================================
VERIFY_TOKEN = "goldenline_secret"
PAGE_ACCESS_TOKEN = os.getenv("PAGE_ACCESS_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

client = OpenAI(api_key=OPENAI_API_KEY)

WHATSAPP_URL = (
    "https://api.callmebot.com/whatsapp.php?"
    "phone=9647818931201&apikey=8423339&text="
)

# =======================================================
# ๐ DAILY STATS
# =======================================================
DAILY_BOOKINGS = 0
DAILY_MESSAGES = 0
DAILY_INCOMPLETE = 0

# =======================================================
# ๐ง SESSIONS
# =======================================================
SESSIONS = {}

BUFFER_DELAY = 15
MEMORY_TIMEOUT = 900


# =======================================================
# ๐ฅ AUTO CLEANER
# =======================================================
def cleaner_daemon():
    while True:
        now = time.time()
        for uid in list(SESSIONS.keys()):
            if now - SESSIONS[uid]["last_message_time"] > 3600:
                del SESSIONS[uid]
        time.sleep(3600)


threading.Thread(target=cleaner_daemon, daemon=True).start()


# =======================================================
# โ๏ธ Typing Indicator
# =======================================================
def send_typing(receiver):
    url = "https://graph.facebook.com/v18.0/me/messages"
    params = {"access_token": PAGE_ACCESS_TOKEN}
    payload = {"recipient": {"id": receiver}, "sender_action": "typing_on"}
    requests.post(url, params=params, json=payload)


# =======================================================
# ๐ข Normalize Arabic Digits
# =======================================================
def normalize_numbers(text):
    arabic = "ููกูขูฃูคูฅูฆูงูจูฉ"
    english = "0123456789"
    table = str.maketrans(arabic, english)
    return text.translate(table)


# =======================================================
# ๐ข Extract Phone (Arabic + English)
# =======================================================
def extract_phone(text):
    text = normalize_numbers(text)
    m = re.findall(r"07\d{9}", text)
    return m[0] if m else None


# =======================================================
# ๐งพ Extract Name
# =======================================================
def extract_name(text):
    txt = normalize_numbers(text)
    cleaned = ''.join([c if not c.isdigit() else ' ' for c in txt])
    return cleaned.strip() if len(cleaned.strip()) > 1 else None


# =======================================================
# โ๏ธ Send WhatsApp Booking
# =======================================================
def send_whatsapp_booking(name, phone):
    global DAILY_BOOKINGS
    DAILY_BOOKINGS += 1

    msg = f"ุญุฌุฒ ุฌุฏูุฏ:\nุงูุงุณู: {name}\nุงูุฑูู: {phone}\nุงูุฎุฏูุฉ: ูุนุงููุฉ ูุฌุงููุฉ"
    url = WHATSAPP_URL + requests.utils.quote(msg)
    requests.get(url)


# =======================================================
# ๐ DAILY REPORT GENERATION
# =======================================================
def generate_report_text():
    return (
        "๐ ุชูุฑูุฑ ุงูููู โ ุนูุงุฏุฉ ูููุฏู ูุงูู\n\n"
        f"๐ข ุนุฏุฏ ุงูุญุฌูุฒุงุช: {DAILY_BOOKINGS}\n"
        f"โ๏ธ ุนุฏุฏ ุงูุฑุณุงุฆู: {DAILY_MESSAGES}\n"
        f"โณ ุทูุจุงุช ุบูุฑ ููุชููุฉ: {DAILY_INCOMPLETE}\n"
    )


# =======================================================
# ๐ฑ Send Report to WhatsApp
# =======================================================
def send_whatsapp_report():
    text = generate_report_text()
    url = WHATSAPP_URL + requests.utils.quote(text)
    requests.get(url)


# =======================================================
# โฐ Daily 9 PM Report
# =======================================================
def report_daemon():
    global DAILY_BOOKINGS, DAILY_MESSAGES, DAILY_INCOMPLETE

    while True:
        now = time.localtime()
        if now.tm_hour == 21 and now.tm_min == 0:

            send_whatsapp_report()

            DAILY_BOOKINGS = 0
            DAILY_MESSAGES = 0
            DAILY_INCOMPLETE = 0
            SESSIONS.clear()

            time.sleep(60)

        time.sleep(5)


threading.Thread(target=report_daemon, daemon=True).start()


# =======================================================
# โณ 30-MIN FOLLOW UP
# =======================================================
def follow_up_checker(user_id, snapshot_time):
    time.sleep(1800)

    st = SESSIONS.get(user_id)
    if not st:
        return

    if (
        st["last_message_time"] == snapshot_time
        and st["phone"] == ""
        and not st["followup_sent"]
    ):
        global DAILY_INCOMPLETE
        DAILY_INCOMPLETE += 1

        send_message(
            user_id,
            "ุญุจู ุฅุฐุง ุจุนุฏู ุชุญุชุงุฌ ุชุญุฌุฒุ ูููู ุญุชู ุฃูููู ุงูููุนุฏ โค๏ธ\n"
            "ุงููุญุต ูุฌุงูู ููุง ูุงุฎุฐ ููุช."
        )
        st["followup_sent"] = True


# =======================================================
# ๐ง BUFFER (15 SECONDS)
# =======================================================
def schedule_reply(user_id):
    time.sleep(BUFFER_DELAY)

    st = SESSIONS.get(user_id)
    if not st:
        return

    now = time.time()
    if now - st["last_message_time"] >= BUFFER_DELAY:

        send_typing(user_id)

        user_text = st["history"][-1] if st["history"] else ""
        reply = ask_openai(user_id, user_text)
        send_message(user_id, reply)


# =======================================================
# ๐ฅ Add Message
# =======================================================
def add_user_message(user_id, text):
    global DAILY_MESSAGES
    DAILY_MESSAGES += 1

    now = time.time()

    # ูููุฉ ุณุฑ ุงูุงุญุตุงุฆูุฉ
    if text.strip() == "Faty2000":
        send_whatsapp_report()
        return

    # ุฌูุณุฉ ุฌุฏูุฏุฉ
    if (
        user_id not in SESSIONS
        or (now - SESSIONS[user_id]["last_message_time"] > MEMORY_TIMEOUT)
    ):
        SESSIONS[user_id] = {
            "history": [],
            "name": "",
            "phone": "",
            "last_message_time": now,
            "followup_sent": False
        }

    st = SESSIONS[user_id]
    st["history"].append(text)
    st["last_message_time"] = now

    threading.Thread(target=follow_up_checker, args=(user_id, now)).start()

    phone = extract_phone(text)
    name = extract_name(text)

    # ุญุฌุฒ ูุจุงุดุฑ
    if phone:
        final_name = name if name else "ุจุฏูู ุงุณู"

        st["phone"] = phone
        st["name"] = final_name
        st["followup_sent"] = True

        send_whatsapp_booking(final_name, phone)

        send_message(
            user_id,
            f"ุชู ุชุซุจูุช ููุนุฏู ูุจุงุดุฑุฉ ๐\n"
            f"ุงูุฑูู: {phone}\n"
            "ุงูุฎุฏูุฉ: ูุนุงููุฉ ูุฌุงููุฉ\n"
            "ูุณู ุงููุชุงุจุนุฉ ุฑุงุญ ูุชูุงุตู ููุงู ุฎูุงู ูุญุธุงุช โค๏ธ"
        )
        return

    threading.Thread(target=schedule_reply, args=(user_id,)).start()


# =======================================================
# ๐ค GPT Handler โ ANSWER ONLY LAST MESSAGE
# =======================================================
def ask_openai(user_id, text):
    st = SESSIONS[user_id]

    history_text = ""
    if len(st["history"]) > 1:
        history_text = " | ".join(st["history"][:-1])

    # ุงูุจุฑููุจุช ุงููุงูู ุจุฏูู ุฃู ุชุบููุฑ
    big_prompt = """
ุงูุช ุงุณูู ุนูู ููุถู ุงูููู ุณูุชุฑ ุจุนูุงุฏุฉ ูููุฏู ูุงููุ
ูุถููุชู ุชุฑุฏ ุนูู ุงูุฑุณุงุฆู ุจุงูููุฌุฉ ุงูุนุฑุงููุฉ ุ ูุจุฏูู ูุจุงูุบุฉ ูุชุฌุงูุจ ุนูู ุฌููุน ุงุณุชูุณุงุฑุงุชูู ุจุทุฑููุฉ ุชุทูู ุงููุฑุงุฌุน ููููู ุฌูุงุจ ูุงูู ุนู ูู ุดู ูุฎุต ุทุจ ุงูุงุณูุงู ุ 
ููุงุญุธุฉ ูก :- ุชุงุฎุฐ ุจุนูู ุงูุงุนุชุจุงุฑ ุชุงุฑูุฎ ุงููุญุงุฏุซุฉ ุงููุฑุณู ูุน ุงููุญุงุฏุซุฉ ูุชุฑุฏ ุนูู ุงุฎูุฑ ุฑุณุงูุฉ ููุท .
ููุงุญุธุฉ ูข :- ุงุฐุง ุงููุฑุงุฌุน ุนูุฏุฉ ุดููุฉ ุงู ุนุตุจู ุงู ูุดุชูู ูู ุนูู ุงูุนูุงุฏุฉ ุ ุชุนุชุฐุฑ ููู ุจุทุฑููุฉ ููุฐุจุฉ ูุชุทูุจ ููู ุงูุงุณู ูุฑูู ุงูุชูููู ุญุชู ูุชุตู ุจูู ูุงุฐุง ุงุณุชูุฑ ุจุงูุชุฐูุฑ ( ูุจุงุดุฑุฉ ุจูุบุฉ ูุชุตู ุนูู ุฑูู ุงูุนูุงุฏุฉ ูุชูุทูู ุงูุฑูู )

ููุงู ุจุนุถ ุงูููุงุญุธุงุช ุงูู ุฑุงุญ ุชุณุชูุงุฏ ูููุง ุนูุฏ ุงูุฑุฏ ุนูู ุงููุฑุงุฌุนูู :-

ุชูุงุตูู ุงูุนูุงุฏุฉ :-
ุงูุงุณู : ุนูุงุฏุฉ ูููุฏู ูุงูู ูุทุจ ูุชุฌููู ุงูุงุณูุงู.
ููุช ุงูุฏูุงู : ููููุง ูู ุงูุณุงุนุฉ ูคู ุงูู ุงูุณุงุนุฉ ูฉู ุนุฏู ููู ุงูุฌูุนุฉ ุนุทูุฉ ุงูุนูุงุฏุฉ
ุงูุนููุงู : ุจุบุฏุงุฏ ุฒูููุฉ ุดุงุฑุน ุงูุฑุจูุนู ุงูุฎุฏูู ุฏุงุฎู ูุฑุงุฌ ูุฌูุน ุงุณุทูุจูู 
ุฑูู ุงููุงุชู :- 07728802820

ุงูุญุดูุฉ ุงูุชุฌููููุฉ ุฌูุณุฉ ูุญุฏุฉ
ุญุดูุฉ ุงูุฌุฐุฑ ูู ุฌูุณุฉ ุงูู ุซูุงุซุฉ ุฌูุณุงุช ุญุณุจ ุงูุชูุงุจ ุงูุณู
ุชุบููู ุงูุงุณูุงู ( ุฒุงุฑููู ุ ุงููุงูุณ ) ุฎูุงู ุฌูุณุชูู ูุจููุงุชูู ูู ูฅ ุงูู ูง ุงูุงู
ุถูุงู ุงูุนูุงุฏุฉ ุฌูุฏุฉ ุงูุนูู ูุฏู ุงูุญูุงุฉ
ุงุฐุง ูุงู ุงููุฑุงุฌุน ูุงูู ุชุฎููุถุงุช ุชููู ุงูู ูุงู ุงุณุนุงุฑ ุนุฑูุถ ุ ุจุณ ุงูุทุจูุจ ูููุตุฑ ููุงู ุงู ุดุงุก ุงููู
ุญุงูู ุชููู ุงูุงุบูุงุท ุงูุงููุงุฆูุฉ ูุชุตุญูุญูุง ุญุณุจ ุตูุงุบ ุงูุฌููุฉ
ุชููู ุจุชุญููู ุงูุทูุจ ุงูุฎุงุต ูููุฑุงุฌุน ูุซู ุชููู ุจุฌูุน ุงููุจูุบ ุงูููู ูููุฑุงุฌุน ุญุณุจ ุนุฏุฏ ุงูุงุณูุงู ุงูู ูุฑูุฏูุง .... ุงูุฎ 
ุงุฐุง ุณุงูู ุงู ูุงุฒู ุญุฌุฒ ุงู ุฑุงุฏ ูุญุฌ ุชุงุฎุฐ ููู ุงูุงุณู ูุงูุฑูู ูุจุนุฏุนุง ุชุจูุบู ุงู ุฑุงุญ ูุชู ุงูุชูุงุตู ููุงู ูู ูุจู ูุณู ุงููุชุงุจุนุฉ ูู ุงูุนูุงุฏุฉ ูุชุญุฏูุฏ ููุนุฏ ุงูุญุฌุฒ
ูุง ุชูู ุจุงูุชุฑุญูุจ ููุท ุนูุฏูุง ูููู ุจุงูุชุญุฑูุจ ุจู ุงูุงูู
ุญุงูู ุชููู ุตุฏูู ูููู ูุชุฌุงูุจ ุนู ุงู ุงุณุชูุณุงุฑ ุจุทุฑููุฉ ุงุญุชุฑุงููุฉ ุญุชู ูู ูุฐุงูุฑูู ูุนูููุงุช ุนููุง
ุงู ููุน ุชุบููู ( ุฒุงุฑููู ุ ุฒุงุฑููู ุงููุงูุณ ) ูุญุชุงุฌ ุงูู ุจุฑุฏ ุฎููู ุญุชู ูุชุณุจุจ ูุดุงูู ุจุงููุซุฉ ุจุงููุณุชูุจู
ุงูู ุงุบูุงุท ุงููุงุฆูุฉ ููุฑุงุฏูุงุช ุฑุงุญ ุชุตุนุจ ุนููู ุงูููู ูุซู ( ูุจู ุ ุบูุงู ุ ุชูุจูู = ุชุบููู ) ุ ( ุทุงุญ ุ ููุน ุ ุงูุดูุน = ุงูููุน ) ุ ( ุชุญุดุงู ุ ุชุญุดูุฉ = ุญุดูุฉ ) ุ ( ูุง ุจููุง ูุฌุงู , ููุง ููุง ุจุงููููุฑ , ุนูู ููููู ููุงูู , ูููู ุงุฌูุจ\ูุฌูุจ\ุชุฌูุจ , ูุฒู ุงููู ูู ุงูุณุนุฑ = ุงููุฑุงุฌุน ูุทูุจ ุชุฎููุถ )ุ ( ููุฌุนูู ุ ุชูุฌุน ุ ูููุชูู = ุงูู )
ุงุฐุง ูุงู ููู ุงูุฏูุชูุฑ ุงู ุงุณู ุงูุฏูุชูุฑ ููู ุงุญูุฉ ูุฑูุฒ ูููุฌูุฏ ุงูุซุฑ ูู ุฏูุชูุฑ ููููู ุงููุงุก ุจุงูุนูู , ุงุฐุง ูุงู ุฏูุชูุฑ ูู ุฏูุชูุฑุฉ ููู ุงูู ุฏูุชูุฑ ูุงูู ุฏูุชูุฑุฉ
ููุงุนุฏ ุงูุฑุฏ ุงูุฐููุฉ (ููู ุฌุฏุงู):
1. ููููุน ุงูุฑูุถ ุงููุจุงุดุฑ: ุฅุฐุง ุณุฃู ุนู ุชุฎููุถ ุฃู ูุงู "ุบุงูู"ุ ุฅูุงู ุฃู ุชููู "ูุง ูุงูู" ุฃู "ุงูุณุนุฑ ุซุงุจุช".
2. ุณูุงุณุฉ ุงูุฅููุงุน: ุฌุงูุจ ุฏุงุฆูุงู ุจุฃู "ุงูุฃุณุนุงุฑ ุงูุญุงููุฉ ูู ุฃุณุนุงุฑ ุนุฑูุถ ูุชูุงูุณูุฉ ุฌุฏุงู" ูุงุฑุจุท ุงูุณุนุฑ ุจู (ุงูููุงุฏ ุงูุฃููุงููุฉ + ุงูุถูุงู ุงูุญูููู). ุญุณุณู ุฅูู ูุงุฎุฐ ุตููุฉ ููุชุงุฒุฉ.
3. ุนุฏู ุชูุฑุงุฑ ุงูุชุฑุญูุจ: ุงูุชุฑุญูุจ ูุฑุฉ ูุงุญุฏุฉ ููุทุ ุจุนุฏูุง ุงุฏุฎู ุจุงูุฌูุงุจ ููุฑุงู.
4. ุงูุงุฎุชุตุงุฑ: ุฌูุงุจู ุณุทุฑูู ุฃู ุซูุงุซุฉุ


ุงูุงุณุนุงุฑ ูุงูุนุฑูุถ :-

ูก: ุงูุฒุงุฑููู 75 ุงูู ุฏููุงุฑ
ูข: ุงูุฒุงุฑููู ุงููุงูุณ 100 ุงูู ุฏููุงุฑ
ูฃ: ุงูููุน 25 ุงูู ุฏููุงุฑ
ูค: ุงูุญุดูุฉ ุงูุชุฌูููุฉ 35 ุงูู ุฏููุงุฑ
ูฅ: ุญุดูุฉ ุงูุฌุฐุฑ 125 ุงูู ุฏููุงุฑ
ูฆ: ุชุจููุถ ุงูุงุณูุงู ุจุงูููุฒุฑ 100 ุงูู ุฏููุงุฑ
ูง: ุชูุถูู ุงูุงุณูุงู 25 ุงูู ุฏููุงุฑ
ูจ: ุชูููู ุงูุงุณูุงู 450 ุงูู ูููู
ูฉ: ุฒุฑุงุนุฉ ุงูุงุณูุงู ุงูุชูููุฏูู ( ุงูููุฑู 350 ุ ุงูุงููุงูู 450 )
ูกู: ุฒุฑุงุนุฉ ุงููู ุงููุงูู ููุฒุฑุนุงุช ุงูููุฑูุฉ ููููู ู 750 ุงูู ุฏููุงุฑ ุฒุฑุนุงุช ุงููุงููุฉ
ูกูก: ุงุจุชุณุงูุฉ ุงููุดุงููุฑ ุฒุงุฑููู 16 ุณู ููููู ู 200 ุงูู ูุงุฐุง ุณุงูู ูุงู ุงุญุชุงุฌ ูุซูุง 20 ุณู ุชุฌูุน ุงูู ุงูุนุฏุฏ ุงูููู ุจูุงุก ุนูู ุณุนุฑ ุณู ุงูุฒุงุฑููู
ุงุจุชุณุงูุฉ ุงููุดุงููุฑ ุฒุงุฑููู ุงููุงูุณ 16 ุณู ููููู ู 600 ุงูู ูุงุฐุง ุณุงูู ูุงู ุงุญุชุงุฌ ูุซูุง 20 ุณู ุชุฌูุน ุงูู ุงูุนุฏุฏ ุงูููู ุจูุงุก ุนูู ุณุนุฑ ุณู ุงูุฒุงุฑููู ุงููุงูุณ
12: ูุธุงู ุงูุงูุณุงุท ูุชููุฑ ููููุถููู ูุงููุชูุงุนุฏูู ุนูู ูุตุฑู ุงูุฑุงูุฏูู ( ูู ูุงุฑุฏ ) ุงูุณุงุท ููุฏุฉ 10 ุงุดูุฑ ูููุงุฆุฏ ุนุดุฑูู ุจุงูููุฉ ูููุตุฑู
"""

    restrain_history = """
ูุฐู ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ ูููู ุทุฑููุฉ ุงูููุงู ููุท.
ูุฌุจ ุฃู ุชุฑุฏ ุนูู ุขุฎุฑ ุฑุณุงูุฉ ููุท.
ุชุฌุงูู ุฌููุน ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ ุญุชู ูู ุชุญุชูู ุฃุณุฆูุฉ.
"""

    messages = [
        {"role": "system", "content": big_prompt},
        {"role": "system", "content": restrain_history},
        {"role": "system", "content": f"History:\n{history_text}"},
        {"role": "user", "content": text}
    ]

    rsp = client.chat.completions.create(
        model="gpt-4.1",
        messages=messages,
        max_tokens=300
    )

    return rsp.choices[0].message.content.strip()


# =======================================================
# ๐ก WEBHOOK
# =======================================================
@app.route("/webhook", methods=["GET"])
def verify():
    mode = request.args.get("hub.mode")
    token = request.args.get("hub.verify_token")
    challenge = request.args.get("hub.challenge")

    if mode == "subscribe" and token == VERIFY_TOKEN:
        return challenge, 200

    return "Error", 403


@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()

    for entry in data.get("entry", []):
        for ev in entry.get("messaging", []):
            uid = ev["sender"]["id"]

            if "message" in ev and "text" in ev["message"]:
                add_user_message(uid, ev["message"]["text"])

    return "OK", 200


# =======================================================
# โ๏ธ Send Message
# =======================================================
def send_message(receiver, text):
    url = "https://graph.facebook.com/v18.0/me/messages"
    params = {"access_token": PAGE_ACCESS_TOKEN}
    payload = {"recipient": {"id": receiver}, "message": {"text": text}}
    requests.post(url, params=params, json=payload)


# =======================================================
# ๐ Run Server
# =======================================================
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)
